<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>屿间导航</title>
    <link rel="icon" type="image/png" href="https://github.com/yujian-home/yujian-images/blob/main/logo.png?raw=true">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Pacifico&family=Playfair+Display:wght@700&family=Roboto:wght@400;700&family=Montserrat:wght@700&family=ZCOOL+QingKe+HuangYou&family=Ma+Shan+Zheng&family=Liu+Jian+Mao+Cao&family=Noto+Sans+SC:wght@300;400;500&family=Long+Cang&family=ZCOOL+XiaoWei&family=Caveat:wght@700&family=Shadows+Into+Light&family=Fredericka+the+Great&family=Special+Elite&display=swap" rel="stylesheet">
    
  <script src="https://code.bdstatic.com/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-color: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --category-color: #ffffff;
            --bookmark-color: #ffffff;
            --title-font: "Pacifico", cursive;
            --subtitle-font: "'Long Cang', cursive";
            --border-color: rgba(255, 255, 255, 0.4);
            --button-bg-color: rgba(255, 255, 255, 0.15);
            --button-hover-bg-color: rgba(255, 255, 255, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            /* === 原有样式 === */
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            transition: background 0.5s ease, color 0.5s ease;
            padding: 20px;             /* 保持原有的边缘留白 */
            position: relative;
            padding-bottom: 100px;
        }

.container {
            /* === 核心修复：保持宽度撑满 === */
            width: 100%;
            max-width: 1250px;
            margin: 0 auto;
            
            position: relative;
            z-index: 10;
            
            /* === ✨ 这里改成了 20vh ✨ === */
            padding-top: 20vh !important;
            
            padding-left: 0;
            padding-right: 0;
        }

        /* 大屏适配 */
        @media (min-width: 1440px) {
            .container {
                /* 确保大屏也保持 20vh 的比例，但在 120px 到 300px 之间伸缩 */
                padding-top: clamp(120px, 20vh, 300px) !important;
            }
        }

        /* 笔记本/平板适配 */
        @media (max-width: 1080px) {
            .container {
                /* 小屏稍微小一点点，给内容留空间，但也强制生效 */
                padding-top: clamp(80px, 18vh, 200px) !important;
            }
        }

        /* --- 调整版：超细腻复古纸张纹理 (Fine Vintage Paper) --- */
        .texture-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            /* 关键修改：baseFrequency 改为 0.6 (数值越大越细腻)，numOctaves 改为 2 (降低复杂度更柔和) */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paper'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3CfeDiffuseLighting lighting-color='white' surfaceScale='1'%3E%3CfeDistantLight azimuth='45' elevation='60'/%3E%3C/feDiffuseLighting%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper)' opacity='1'/%3E%3C/svg%3E");
            mix-blend-mode: overlay;
            opacity: 0.05; /* 稍微增加一点透明度，让细腻的纹理能被看清 */
            backdrop-filter: none;
        }

        /* 新的装饰层 */
        .decorative-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            opacity: 0.3;
            background-size: 300px 300px;
            background-position: 0 0;
        }

        .background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        /* ============================================
           优化版皮肤装饰层 - 保留精选皮肤
           ============================================ */

        /* 2. 赛博科技 (霓虹网格风格 - 科技与赛博朋克融合) */
        .skin-decor-cyber {
            background-image: 
                linear-gradient(90deg, rgba(0, 229, 255, 0.1) 1px, transparent 1px),
                linear-gradient(0deg, rgba(0, 229, 255, 0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.4;
        }
        .skin-decor-cyber::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 229, 255, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 64, 129, 0.3) 0%, transparent 50%);
            opacity: 0.5;
        }
        .skin-decor-cyber::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00e5ff, transparent);
            animation: scanLine 3s linear infinite;
        }


        /* 皮肤装饰层动画 */
        @keyframes pixelMove {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }

        @keyframes scanLine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        @keyframes nebulaPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.02); }
        }

        /* 标题样式 */
        .header {
            text-align: center;
            padding: 5px 0 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 110px;
            margin-bottom: 5px;
        }

        .page-title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin-bottom: 5px;
        }

        .page-title {
            font-size: 3.2rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px var(--shadow-color);
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            color: var(--text-color);
            font-family: var(--title-font);
            line-height: 1.2;
            position: relative;
            overflow: hidden;
        }

        .page-title:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: var(--text-color);
            transition: width 0.3s ease;
        }

        .page-title:hover::after {
            width: 80%;
        }

        .page-subtitle {
            font-size: 1.6rem;
            color: var(--text-color);
            font-family: var(--subtitle-font);
            font-weight: 300;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            line-height: 1.5;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            padding: 5px 0;
        }

        .page-subtitle::before,
        .page-subtitle::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30px;
            height: 1px;
            background: var(--text-color);
            opacity: 0.3;
        }

        .page-subtitle::before {
            left: -40px;
        }

        .page-subtitle::after {
            right: -40px;
        }

        .page-title-icon {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            vertical-align: middle;
            border-radius: 10px;
            object-fit: cover;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .page-title-icon.empty {
            display: none;
        }

        /* 搜索框样式 - 胶囊版唯一修正 */
        .search-container {
            max-width: 1250px;
            margin: 0 auto 15px;
            position: relative;
            z-index: 10;
            padding-left: 0;
            padding-right: 0;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--button-bg-color);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 5px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            width: 100%;
            transition: all 0.3s ease;
        }

        .search-box:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .search-engine-selector {
            position: relative;
            min-width: 60px;
            z-index: 100;
        }

        /* 核心胶囊形状定义 */
        .current-engine {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            
            /* 关键：拉长成椭圆胶囊状 */
            width: 60px !important; 
            height: 44px;
            padding: 0 10px;
            margin: 4px;
            border-radius: 50px !important; 

            /* 背景跟随皮肤设置 */
            background: var(--button-bg-color) !important; 
            border: none !important;
            box-shadow: none !important;
        }

        .current-engine:hover {
            background: var(--button-hover-bg-color) !important;
        }

/* 默认状态：白色/单色 */
        .current-engine i,
        .current-engine svg {
            font-size: 26px !important;
            color: var(--text-color); /* 去掉 !important，交给JS控制变量 */
            fill: var(--text-color);
            transition: all 0.3s ease;
            /* 默认加滤镜让它变白 */
            filter: brightness(0) invert(1); 
        }

        /* 悬停状态：恢复彩色 */
        .search-box:hover .current-engine i,
        .search-box:hover .current-engine svg,
        .current-engine:hover i,
        .current-engine:hover svg {
            filter: none !important; /* 移除变白滤镜 */
            /* 关键修改：使用JS注入的品牌色变量 */
            color: var(--item-brand-color) !important; 
            fill: var(--item-brand-color) !important;
        }

        /* 搜索引擎下拉网格 */
        .engine-grid {
            position: absolute;
            top: 100%;
            left: 0;
            width: 400px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-top: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            display: none;
            z-index: 1000;
            color: #333;
            padding: 15px;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .engine-grid.show {
            display: grid;
            animation: fadeInUp 0.3s ease;
        }

        .engine-grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            text-align: center;
            min-height: 70px;
        }

        .engine-grid-item:hover {
            background: rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .engine-grid-icon {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .engine-grid-icon svg,
        .engine-grid-icon i {
            filter: none !important;
        }

        .engine-grid-name {
            font-size: 12px;
            line-height: 1.3;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 16px;
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-input.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 识图按钮样式 */
        .image-search-btn {
            background: var(--button-bg-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-right: 8px;
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }

        .image-search-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--button-hover-bg-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .image-search-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .image-search-btn:hover {
            transform: scale(1.05);
        }

        .image-search-btn i {
            position: relative;
            z-index: 1;
        }

        .image-search-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .search-btn {
            background: var(--button-bg-color);
            border: none;
            border-radius: 50%;
            width: 46px;
            height: 46px;
            color: var(--text-color);
            
            /* ✨✨✨ 新增这一行：调整图标大小 ✨✨✨ */
            font-size: 24px;  /* 你可以改成 22px, 26px 甚至 28px */
            
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-right: 3px;
            position: relative;
            overflow: hidden;
        }

        .search-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--button-hover-bg-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .search-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .search-btn:hover {
            transform: scale(1.05);
        }

        .search-btn i {
            position: relative;
            z-index: 1;
        }

        .search-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* 分类按钮样式 */
        .categories-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            position: relative;
            min-height: 45px;
            padding-left: 0;
            width: 100%;
            overflow: visible;
        }

        .category-item {
            position: relative;
            cursor: move;
        }

        .category-item.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .category-btn {
            background: var(--button-bg-color);
            border: 2px solid var(--border-color);
            color: var(--category-color);
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            display: inline-block;
            white-space: nowrap;
            overflow: hidden;
        }

        .category-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--button-hover-bg-color);
            transition: left 0.3s;
        }

        .category-btn:hover::before {
            left: 0;
        }

        .category-btn span {
            position: relative;
            z-index: 1;
        }

        .category-btn.active,
        .category-btn:hover {
            border-color: rgba(255, 255, 255, 0.8);
        }

        .category-btn.active {
            color: var(--category-color);
            border-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* 添加分类按钮 */
        .add-category-btn {
            background: var(--button-bg-color);
            border: 2px dashed var(--border-color);
            color: var(--category-color);
            padding: 8px 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 600;
            display: none;
            white-space: nowrap;
        }

        .edit-mode .add-category-btn {
            display: inline-block;
        }

        .add-category-btn:hover {
            background: var(--button-hover-bg-color);
            color: var(--category-color);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* 分类编辑按钮 - 修复：使用透明背景 */
        .category-edit-buttons {
            position: absolute;
            top: -8px;
            right: -8px;
            display: none;
            gap: 5px;
            z-index: 10;
        }

        .edit-mode .category-edit-buttons {
            display: flex;
        }

        .edit-btn-small {
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            z-index: 5;
            padding: 0;
            margin: 0;
            /* 修复：添加透明背景，与网站编辑按钮一致 */
            background: var(--button-bg-color) !important;
        }

        .edit-btn-small:hover {
            transform: scale(1.1);
            background: var(--button-hover-bg-color) !important;
        }

        /* 网站网格样式 */
        .bookmarks-section {
            display: none;
            animation: fadeIn 0.5s;
        }

        .bookmarks-section.active {
            display: block;
        }

        .bookmarks-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .edit-mode .bookmarks-grid {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
        }

        .bookmark-item {
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--bookmark-color);
            min-height: 48px;
            padding: 8px 10px;
            border-radius: 10px;
            text-decoration: none;
            width: 160px;
            overflow: hidden;
        }

        .bookmark-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0);
            transition: background 0.3s;
            z-index: 0;
        }

        .bookmark-item:hover::before {
            background: rgba(255, 255, 255, 0.1);
        }

        .bookmark-item.dragging {
            opacity: 0.5;
            transform: scale(1.05) rotate(5deg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            z-index: 100;
        }

        .bookmark-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .empty-slot {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .edit-mode .empty-slot {
            opacity: 0.3;
            visibility: visible;
            pointer-events: auto;
        }

        .bookmark-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 1;
        }

        .bookmark-icon-img {
            width: 26px;
            height: 26px;
            object-fit: contain;
            border-radius: 6px;
            transition: transform 0.3s;
        }

        .bookmark-item:hover .bookmark-icon-img {
            transform: scale(1.1);
        }

        .fallback-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
        }

        /* 默认图标样式 */
        .blue-e-icon {
            background: radial-gradient(circle at 20% 20%, #8fd3ff, #3b6df6 50%, #162d6f 90%);
            color: #f8fbff;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: 700;
            font-family: 'Montserrat', 'Segoe UI', sans-serif;
            letter-spacing: 0.3px;
            box-shadow: 0 6px 18px rgba(59, 109, 246, 0.35);
        }

        .default-favicon {
            background: radial-gradient(circle at 25% 25%, #fef3d7, #f6c77d 45%, #e87e4d 90%);
            color: #2b2b2b;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            font-weight: 800;
            font-size: 13px;
            letter-spacing: 0.3px;
            box-shadow: 0 6px 16px rgba(232, 126, 77, 0.35);
        }

        .bookmark-name {
            font-size: 17px;
            
            /* ✨✨✨ 修复：字体加粗程度调整 ✨✨✨ */
            font-weight: 500; /* 改为500，比normal稍粗，比bold细 */
            
            /* 1. 强制不换行 */
            white-space: nowrap; 
            
            /* 2. 超出部分直接隐藏 */
            overflow: hidden;
            
            /* 3. 直接切断，不显示省略号 */
            text-overflow: clip; 
            
            /* 4. 长度限制 (6.5个字) */
            max-width: 6.5em; 
            
            flex: 1;
            display: block;
        }

        .bookmark-edit-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--button-bg-color);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            color: var(--text-color);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s;
            z-index: 5;
        }

        .edit-mode .bookmark-edit-btn {
            display: flex;
        }

        .bookmark-edit-btn:hover {
            background: var(--button-hover-bg-color);
            transform: scale(1.1);
        }

        /* 添加行按钮 */
        .add-row-btn {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            margin-top: 10px;
        }

        .edit-mode .add-row-btn {
            display: flex;
        }

        .add-row-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* 删除行按钮 */
        .remove-row-btn {
            grid-column: 1 / -1;
            background: rgba(255, 107, 107, 0.1);
            border: 1px dashed rgba(255, 107, 107, 0.3);
            color: rgba(255, 107, 107, 0.7);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: none;
            justify-content: center;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            margin-top: 6px;
        }

        .edit-mode .remove-row-btn {
            display: flex;
        }

        /* 右下角设置按钮 */
        .settings-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--button-bg-color);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            overflow: hidden;
        }

        .settings-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--button-hover-bg-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .settings-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .settings-btn:hover {
            transform: scale(1.1) rotate(30deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .settings-btn i {
            position: relative;
            z-index: 1;
        }

        .settings-btn.confirm-mode {
            background: rgba(76, 175, 80, 0.8) !important;
            border-color: rgba(76, 175, 80, 0.9) !important;
        }

        .settings-btn.confirm-mode:hover {
            background: rgba(76, 175, 80, 0.9) !important;
        }

        /* 设置菜单 */
        .settings-menu {
            position: fixed;
            bottom: 90px;
            right: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
            z-index: 100;
            color: #333;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .settings-menu.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .settings-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        /* 配色和背景模态框 */
        .color-bg-modal-content {
            background: #f8f8f5;
            border-radius: 15px;
            padding: 25px;
            width: 95%;
            max-width: 1000px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: #333;
            max-height: 85vh;
            overflow-y: auto;
        }

        .color-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .color-tab {
            padding: 8px 16px;
            border: none;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #333;
        }

        .color-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .color-tab:hover:not(.active) {
            background: #e0e0e0;
        }

        .color-tab-content {
            display: none;
        }

        .color-tab-content.active {
            display: block;
        }

        /* 皮肤网格 - 优化版 */
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .skin-item {
            background: #f5f5f5;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .skin-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .skin-item.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .skin-preview {
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255,255,255,0.12);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
        }

        .skin-preview::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.18));
            opacity: 0.6;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .skin-item:hover .skin-preview {
            transform: scale(1.05);
        }

        .skin-item:hover .skin-preview::after,
        .skin-item.selected .skin-preview::after {
            opacity: 0.35;
        }

        .skin-name {
            padding: 12px;
            text-align: center;
            background: white;
            font-size: 14px;
            font-weight: 600;
            position: relative;
            z-index: 1;
            color: #333;
            border-top: 1px solid #eee;
        }

        .skin-description {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            font-weight: normal;
            opacity: 0.8;
        }


        /* 颜色选择器 */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-label {
            min-width: 90px;
            font-weight: 500;
        }

        .custom-color-input {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
            overflow: hidden;
        }

        .custom-color-input::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .custom-color-input::-webkit-color-swatch {
            border: none;
        }

        .color-value {
            font-size: 14px;
            color: #666;
            min-width: 70px;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #f8f8f5;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: #333;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #444;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* 数据文本域样式 */
        .data-textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }

        .data-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* 错误提示样式 */
        .error-message {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* 图标选择器样式 */
        .icon-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 10px;
            max-height: 180px;
            overflow-y: auto;
            padding: 8px;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.1);
        }

        .icon-option:hover {
            background: rgba(102, 126, 234, 0.8);
            transform: scale(1.1);
        }

        .icon-option.selected {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        /* 拖拽提示 */
        .drag-hint {
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .edit-mode .drag-hint {
            display: block;
        }

        /* 字体选择器样式 */
        .font-selector-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
            max-height: none;
            overflow: visible;
        }

        .font-type-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .font-type-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            color: #333;
        }

        .font-type-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .font-selector-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-top: 5px;
            max-height: none;
            overflow-y: visible;
            padding: 5px;
        }

        .font-option {
            padding: 8px 5px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            text-align: center;
            background: rgba(0, 0, 0, 0.05);
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            color: #333;
        }

        .font-option:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.05);
        }

        .font-option.selected {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        /* 标题图标预览 */
        .title-icon-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            margin: 8px auto;
            display: block;
            border: 2px solid #ddd;
        }

        /* 图片搜索模态框样式 */
        .image-search-modal-content {
            background: #f8f8f5;
            border-radius: 18px;
            padding: 24px;
            width: 92%;
            max-width: 920px;
            box-shadow: 0 24px 70px rgba(0, 0, 0, 0.28);
            color: #333;
            max-height: 88vh;
            overflow-y: auto;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .image-search-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            align-items: start;
        }

        .image-upload-card,
        .image-url-card {
            background: #fff;
            border-radius: 14px;
            padding: 18px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .image-upload-card h3,
        .image-url-card h3 {
            font-size: 15px;
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
        }

        .image-upload-card {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .upload-section {
            flex: 1;
            min-width: 0;
        }

        .preview-section {
            flex: 0 0 180px;
        }

        .image-url-grid {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .image-search-engines {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (max-width: 820px) {
            .image-upload-card {
                flex-direction: column;
            }
            .preview-section {
                flex: 1;
                width: 100%;
            }
            .image-search-modal-content {
                max-width: 96vw;
            }
            .image-search-engines {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .image-upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            background: #f9f9f9;
        }

        .image-upload-area:hover {
            border-color: var(--primary-color);
            background: #f0f0f0;
        }

        .image-upload-area.dragover {
            border-color: var(--primary-color);
            background: #e8f0fe;
        }

        .image-upload-icon {
            font-size: 40px;
            color: #666;
            margin-bottom: 12px;
        }

        .image-preview-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: none;
        }

        .image-search-engines {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .image-search-engine {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            background: #f5f5f5;
        }

        .image-search-engine:hover {
            background: #e8e8e8;
            transform: translateY(-2px);
        }

        .image-search-engine.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .image-search-engine-icon {
            font-size: 22px;
            margin-bottom: 6px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-search-engine-name {
            font-size: 12px;
            font-weight: 500;
        }

        .image-search-url-input {
            margin-top: 12px;
            display: none;
        }

        /* 动画关键帧 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes dragPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .dragging-pulse {
            animation: dragPulse 1s infinite;
        }

        /* 确认对话框 */
        .confirm-dialog {
            background: #f8f8f5;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            color: #333;
            text-align: center;
        }

        .confirm-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
        }

        .confirm-message {
            font-size: 0.95rem;
            margin-bottom: 15px;
            color: #666;
        }

        .confirm-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* 导入选项样式 */
        .import-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .import-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            background: #f5f5f5;
            cursor: pointer;
            transition: all 0.2s;
        }

        .import-option:hover {
            background: #e8e8e8;
        }

        .import-option.selected {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .import-option input[type="radio"] {
            margin: 0;
        }

        .import-option-label {
            flex: 1;
        }

        .import-option-desc {
            font-size: 11px;
            color: #666;
        }

        /* 字体大小调节容器 */
        .font-size-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .font-size-slider-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .font-size-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
        }

        .font-size-value {
            font-size: 13px;
            font-weight: 500;
            color: #333;
            min-width: 40px;
            text-align: right;
        }

        /* 拖拽增强效果 */
        .category-item.drag-over {
            border: 2px solid var(--primary-color) !important;
            background: rgba(102, 126, 234, 0.1) !important;
            transform: scale(1.05) !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
        }

        .bookmark-item.drag-over {
            border: 2px solid var(--primary-color) !important;
            background: rgba(102, 126, 234, 0.1) !important;
            transform: scale(1.05) !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
        }

        .category-drag-placeholder {
            border: 2px dashed var(--primary-color);
            border-radius: 25px;
            background: rgba(102, 126, 234, 0.05);
            height: 42px;
            margin: 0 12px;
            transition: all 0.3s;
        }

        .bookmark-drag-placeholder {
            border: 2px dashed var(--primary-color);
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
            height: 52px;
            width: 165px;
            margin: 0 10px;
            transition: all 0.3s;
        }

        /* 字体与标题中主标题和副标题在同一行 */
        .title-input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .title-input-group {
            flex: 1;
        }

        /* 好看的默认图标样式 */
        .default-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        /* 标题图标与按钮在一行 */
        .title-icon-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .title-icon-upload-group {
            flex: 1;
        }

        .title-icon-remove-group {
            flex-shrink: 0;
        }

        /* 上传图片预览对话框 */
        .upload-preview-modal .modal-content {
            max-width: 500px;
        }

        .upload-preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
        }

        .upload-preview-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* 手机端优化 */
        @media (max-width: 768px) {
            .search-box {
                flex-direction: row;
                border-radius: 15px;
                padding: 5px;
                flex-wrap: nowrap;
            }
            
            .search-engine-selector {
                width: auto;
                margin-bottom: 0;
                min-width: 60px;
            }
            
            .search-input {
                width: auto;
                margin-bottom: 0;
                flex: 1;
                font-size: 14px;
            }
            
            .search-input::placeholder {
                color: transparent;
            }
            
            .search-input:focus::placeholder {
                color: transparent;
            }
            
            .search-btn {
                width: 40px;
                height: 40px;
                margin-right: 0;
            }

            .image-search-btn {
                width: 36px;
                height: 36px;
                margin-right: 6px;
                font-size: 14px;
            }
            
            .current-engine {
                width: 50px;
                padding: 8px 10px;
            }
            
            .engine-grid {
                width: 250px;
                grid-template-columns: repeat(2, 1fr);
                left: 50%;
                transform: translateX(-50%);
            }
            
            .bookmarks-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .categories-container {
                gap: 6px;
            }
            
            .category-btn {
                padding: 6px 14px;
                font-size: 13px;
            }
            
            .font-selector {
                grid-template-columns: repeat(3, 1fr);
            }

            .image-search-engines {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .title-input-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .title-icon-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .title-icon-remove-group {
                width: 100%;
            }
            
            .page-subtitle {
                max-width: 90%;
                font-size: 1.4rem;
            }

            .container {
                padding-top: 12%; /* 手机端调整 */
            }

            .skin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .bookmarks-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .engine-grid {
                width: 350px;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .icon-selector {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .skin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .font-selector {
                grid-template-columns: repeat(4, 1fr);
            }

            .image-search-engines {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 992px) {
            .bookmarks-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .page-title {
                font-size: 2.5rem;
            }
            
            .engine-grid {
                width: 300px;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .icon-selector {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .skin-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .font-selector {
                grid-template-columns: repeat(3, 1fr);
            }

            .image-search-engines {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .bookmarks-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .settings-menu {
                right: 15px;
                bottom: 80px;
            }
            
            .icon-selector {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .skin-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .font-selector {
                grid-template-columns: repeat(2, 1fr);
            }

            .image-search-engines {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .bookmarks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .page-title {
                font-size: 2rem;
            }
            
            .page-subtitle {
                font-size: 1.2rem;
                padding: 0 15px;
                max-width: 95%;
            }
            
            .engine-grid {
                width: 200px;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .icon-selector {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .skin-grid {
                grid-template-columns: repeat(1, 1fr);
            }
            
            .search-box {
                padding: 3px;
            }
            
            .search-input {
                font-size: 12px;
                padding: 8px 10px;
            }
            
            .current-engine {
                width: 45px;
                padding: 6px 8px;
            }
            
            .search-engine-selector {
                min-width: 45px;
            }
            
            .engine-grid {
                width: 180px;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .category-btn {
                padding: 5px 12px;
                font-size: 12px;
            }
            
            .font-selector {
                grid-template-columns: repeat(2, 1fr);
            }

            .image-search-engines {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        /* ============================================================
           🎨 全局皮肤深度定制 UI (Search Box, Buttons, Categories)
           ============================================================ */

        /* 通用过渡：让形状变化丝滑 */
        .search-box, .search-btn, .image-search-btn, .category-btn, .current-engine {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* ----------------------------------
           1. 像素怀旧 (Skin 1): 方块、硬阴影、游戏风
           ---------------------------------- */
        body[data-skin="skin1"] .search-box,
        body[data-skin="skin1"] .search-btn,
        body[data-skin="skin1"] .image-search-btn,
        body[data-skin="skin1"] .current-engine,
        body[data-skin="skin1"] .category-btn {
            border-radius: 0 !important; /* 强制直角 */
            border-width: 2px !important;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.4) !important; /* 像素硬阴影 */
            background-color: rgba(40, 40, 40, 0.8) !important; /* 深色底 */
        }
        body[data-skin="skin1"] .search-box:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px rgba(0,0,0,0.5) !important;
        }
        body[data-skin="skin1"] .category-btn.active {
            background-color: var(--primary-color) !important;
            color: #000 !important; /* 像素风高亮通常是黑字 */
            box-shadow: 2px 2px 0px rgba(0,0,0,0.6) !important;
            transform: translate(2px, 2px); /* 按下去的效果 */
        }

        /* ----------------------------------
           2. 赛博科技 (Skin 2): 切角、霓虹光、透明感
           ---------------------------------- */
        body[data-skin="skin2"] .search-box {
            background: rgba(0, 20, 40, 0.6) !important;
            border: 1px solid var(--primary-color) !important;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.2), inset 0 0 20px rgba(0, 229, 255, 0.1) !important;
            border-radius: 4px !important;
        }
        /* 科技感切角按钮 */
        body[data-skin="skin2"] .category-btn {
            border-radius: 0 !important;
            border: 1px solid var(--primary-color);
            background: rgba(0, 229, 255, 0.1);
            /* 左右切角 */
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            padding: 8px 20px !important; /* 加宽一点以适应切角 */
        }
        body[data-skin="skin2"] .category-btn:hover,
        body[data-skin="skin2"] .category-btn.active {
            background: var(--primary-color) !important;
            color: #000 !important;
            box-shadow: 0 0 20px var(--primary-color);
            text-shadow: none;
        }
        body[data-skin="skin2"] .search-btn,
        body[data-skin="skin2"] .image-search-btn {
            border-radius: 4px !important;
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* ----------------------------------
           3. 自然清新 (Skin 3): 极致圆润、柔光、磨砂
           ---------------------------------- */
        body[data-skin="skin3"] .search-box {
            border-radius: 50px !important;
            background: rgba(255, 255, 255, 0.4) !important; /* 更亮的磨砂 */
            border: 2px solid rgba(255, 255, 255, 0.6) !important;
            backdrop-filter: blur(20px);
        }
        body[data-skin="skin3"] .category-btn {
            border-radius: 20px !important;
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        body[data-skin="skin3"] .category-btn.active {
            background: #fff !important;
            color: var(--primary-color) !important;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        body[data-skin="skin3"] .search-btn,
        body[data-skin="skin3"] .image-search-btn {
            background: rgba(255, 255, 255, 0.5) !important;
        }

        /* ----------------------------------
           4. 暗黑属性 (Skin 4): 极简、扁平、深灰
           ---------------------------------- */
        body[data-skin="skin4"] .search-box {
            background: rgba(30, 30, 30, 0.9) !important;
            border: 1px solid #444 !important;
            border-radius: 12px !important; /* 适中的圆角 */
            box-shadow: none !important;
        }
        body[data-skin="skin4"] .category-btn {
            background: rgba(50, 50, 50, 0.5);
            border: 1px solid #555;
            border-radius: 8px !important;
            color: #aaa;
        }
        body[data-skin="skin4"] .category-btn.active {
            background: #eee !important;
            color: #000 !important;
            border-color: #fff;
        }
        body[data-skin="skin4"] .search-btn,
        body[data-skin="skin4"] .image-search-btn {
            background: rgba(60, 60, 60, 0.8) !important;
            border: 1px solid #555;
        }

        /* ----------------------------------
           5. 青橙影调 (Skin 5): 胶囊形状、高对比、电影感
           ---------------------------------- */
        body[data-skin="skin5"] .search-box {
            border-radius: 16px 16px 0 0 !important; /* 上圆下方 */
            border-bottom: 3px solid var(--secondary-color) !important;
            background: linear-gradient(to bottom, rgba(10, 25, 47, 0.8), rgba(10, 25, 47, 0.95)) !important;
        }
        body[data-skin="skin5"] .category-btn {
            border-radius: 30px !important; /* 胶囊形 */
            border: 1px solid rgba(255, 152, 0, 0.3);
            letter-spacing: 1px;
        }
        body[data-skin="skin5"] .category-btn.active {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)) !important;
            border: none;
            box-shadow: 0 4px 20px rgba(255, 152, 0, 0.4);
        }
        body[data-skin="skin5"] .search-btn {
            border-radius: 12px !important;
            background: var(--secondary-color) !important;
        }

/* ----------------------------------
           6. 复古艺术 (Skin 6): 方案一 [墨水风] - 亮底深字
           ---------------------------------- */
        body[data-skin="skin6"] .search-box {
            /* 背景：非常浅的米白色，接近纸张原色，看着干净 */
            background: rgba(253, 251, 247, 0.95) !important; 
            /* 边框：深咖啡色双线，增加精致感 */
            border: 3px double #5d4037 !important; 
            border-radius: 6px !important;
            box-shadow: 0 4px 15px rgba(93, 64, 55, 0.15) !important;
        }

        body[data-skin="skin6"] .search-input {
            /* 关键修改：文字改成深褐色（接近黑色），在浅背景上极其清晰 */
            color: #2b1b17 !important;
            font-family: "Courier New", Courier, monospace;
            font-weight: bold;
        }
        
        /* 提示词颜色：半透明的深色 */
        body[data-skin="skin6"] .search-input::placeholder {
            color: rgba(43, 27, 23, 0.4) !important;
        }

        /* 按钮颜色：深色线条，与文字呼应 */
        body[data-skin="skin6"] .search-btn,
        body[data-skin="skin6"] .image-search-btn {
            border: 2px solid #5d4037 !important;
            color: #5d4037 !important;
            background: transparent !important;
        }
        
        body[data-skin="skin6"] .search-btn:hover,
        body[data-skin="skin6"] .image-search-btn:hover {
            background: #5d4037 !important;
            color: #fff !important;
        }

        /* 分类按钮保持深色文字 */
        body[data-skin="skin6"] .category-btn {
            border: 2px solid #5d4037;
            color: #5d4037;
            background: rgba(255,255,255,0.5);
            font-weight: bold;
        }
        body[data-skin="skin6"] .category-btn.active {
            background: #5d4037 !important;
            color: #fff !important;
        }
        /* ✅ 唯一正确的胶囊按钮样式 */
        .current-engine {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            
            /* 核心参数：拉长椭圆形状 */
            width: 60px !important; 
            height: 44px;
            padding: 0 10px;
            margin: 4px;
            border-radius: 50px !important; 

            /* 背景与右侧搜索按钮同步 */
            background: var(--button-bg-color) !important; 
            border: none !important;
            box-shadow: none !important;
        }

        /* 【修复2：确保所有搜索引擎图标悬停变色】 */
        .current-engine i,
        .current-engine svg {
            font-size: 26px !important;
            color: var(--text-color) !important;
            fill: var(--text-color) !important;
            filter: brightness(0) invert(1) !important; /* 默认显示白色/单色 */
            text-shadow: none !important;
            transition: all 0.3s ease !important;
        }

        /* 当鼠标悬停在搜索框或当前引擎按钮上时，图标显示彩色 */
        .search-box:hover .current-engine i,
        .search-box:hover .current-engine svg,
        .current-engine:hover i,
        .current-engine:hover svg {
            filter: none !important; /* 悬停时恢复彩色 */
        }

        /* 皮肤标签页中的路径输入框样式 */
        .skin-path-input {
            height: 32px;
            font-size: 12px;
            flex: 1;
            max-width: none;
            padding: 0 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            background: #fff;
        }

        /* 简单搜索网格样式 */
        .simple-search-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .simple-search-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            text-decoration: none;
            color: #333;
        }

        .simple-search-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .ss-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            color: white;
            font-size: 24px;
        }

        .simple-search-item span {
            font-size: 14px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .simple-search-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .simple-search-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 新增皮肤设置布局样式 */
        .skin-upload-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .skin-upload-row {
            display: grid;
            grid-template-columns: 80% 20%;
            gap: 10px;
            align-items: center;
            background: rgba(0,0,0,0.03);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .skin-upload-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .skin-upload-label {
            font-size: 14px;
            font-weight: bold;
            min-width: 100px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .skin-upload-input {
            flex: 1;
            height: 36px;
            font-size: 13px;
            padding: 0 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: #fff;
        }

        .skin-upload-btn {
            height: 36px;
            padding: 0 15px;
            font-size: 13px;
            border-radius: 8px;
            white-space: nowrap;
        }
/* === 电脑端：锁死不动 === */
        @media (min-width: 769px) {
            html, body {
                overflow: hidden !important; /* 电脑禁止滚动 */
                height: 100% !important;
                width: 100% !important;
            }
        }

        /* === 手机端：允许滑动 === */
        @media (max-width: 768px) {
            html, body {
                overflow-y: auto !important;   /* 允许上下滚动 */
                height: auto !important;       /* 高度自动撑开 */
                touch-action: auto !important; /* 恢复触摸功能 */
                padding-bottom: 80px;          /* 底部留点空隙方便操作 */
            }
        }
    </style>
</head>
<body>
    <div class="texture-layer"></div>
    
    <div class="decorative-layer" id="decorativeLayer"></div>
    
    <img class="background-image" id="backgroundImage" src="" alt="背景">
    
    <div class="container" id="mainContainer">
        <div class="header">
            <div class="page-title-container">
                <h1 class="page-title" id="pageTitle"></h1>
            </div>
            <div class="page-subtitle" id="pageSubtitle">
                每一次与过往照面，都是为了与未来更好地遇见。
            </div>
        </div>
        
        <div class="search-container">
            <div class="search-box">
                <div class="search-engine-selector">
                    <div class="current-engine" id="currentEngine">
                        </div>
                    <div class="engine-grid" id="engineGrid">
                        </div>
                </div>
                <input type="text" class="search-input" id="searchInput" placeholder="输入搜索内容或网址...">
                <button class="image-search-btn" id="imageSearchBtn" title="识图搜图">
                    <i class="fas fa-camera"></i>
                </button>
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <!-- 分类标签 -->
        <div class="categories-container" id="categoriesContainer">
            <!-- 分类按钮将通过JS动态生成 -->
        </div>
        
        <!-- 拖拽提示 -->
        <div class="drag-hint" id="dragHint">
            <i class="fas fa-arrows-alt"></i> 拖拽分类或网站可以调整顺序
        </div>
        
        <!-- 网站内容区域 -->
        <div id="bookmarksContainer">
            <!-- 网站将通过JS动态生成 -->
        </div>
    </div>
    
    <!-- 右下角设置按钮 -->
    <button class="settings-btn" id="settingsBtn">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- 设置菜单 -->
    <div class="settings-menu" id="settingsMenu">
        <button class="settings-item" id="customizeBtn">
            <i class="fas fa-sliders-h"></i> 自定义模式
        </button>
        <button class="settings-item" id="colorBgBtn">
            <i class="fas fa-palette"></i> 配色与背景
        </button>
        <button class="settings-item" id="importExportBtn">
            <i class="fas fa-file-export"></i> 数据备份与恢复
        </button>
        <button class="settings-item" id="loginMenuBtn" style="border-top: 1px solid #eee; margin-top: 5px; color: var(--primary-color);">
            <i class="fas fa-sign-in-alt"></i> 登录 / 注册
        </button>
    </div>
    
<div class="modal" id="imageSearchModal">
        <div class="modal-content" style="max-width: 800px; padding: 30px; text-align: center;">
            <div class="modal-header" style="margin-bottom: 20px;">
                <h2 class="modal-title">选择搜图引擎</h2>
                <button class="close-modal" id="closeImageSearchModalBtn">×</button>
            </div>
            
            <p style="color: #666; margin-bottom: 25px;">点击下方图标，直接前往官方网站进行识图</p>
            
<div class="simple-search-grid">
                <a href="https://image.baidu.com/?fr=shitu" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #2932e1;">
                        <svg viewBox="0 0 1024 1024" width="22" height="22" style="fill: white;"><path d="M512 0C229.8 0 0 229.8 0 512s229.8 512 512 512 512-229.8 512-512S794.2 0 512 0zm0 934c-232.8 0-422-189.2-422-422S279.2 90 512 90s422 189.2 422 422-189.2 422-422 422zm161.8-638c-30.8-19.2-70.6-18.4-98 7.4-8 7.6-13.6 16.8-17.4 26.6-5.8-9.4-14.4-17-25.2-22.4-27.4-13.6-60.4-11-85.4 7.6-43.2 32.2-46 95.2-12.2 135 15.6 18.4 39.2 26.2 62.4 22.8 5.6 30.8 21.6 57.6 46 75.8 30.6 22.8 69.8 29.4 107.2 19.8 38.8-10 65.4-44.6 71.8-86.2 11.2-73.4-38.4-144.2-111.8-158.4 5.2-14.8 15.6-26.2 30-32.2 16.4-6.8 35.8-2.2 47.6 12 11.2 13.4 13.8 32.2 7 48.2 11.4 3 23.4 2.4 34.4-2.2 15.2-6.4 25.2-20.2 27.2-36.6 2-16.6-5.2-32.8-18.6-42.6-18.8-13.8-46.2-7.8-59.2 12.8-1.8 2.8-3.2 5.8-4.4 8.8-2-3.4-4.4-6.6-7.2-9.6-12.8-13.6-32.6-19.6-50.6-16-5.2-10.2-13.2-18.4-23.2-23.4zm-199 53.6c13.2-6.4 29.6-3.2 39.4 8.6 9.8 11.8 10 28.8 1.2 41.2-9 12.8-27.2 16-39.8 7.4-12.4-8.4-16.4-25-9.4-38 2.2-7.8 8.6-13.2 16.6-15.6l-8-3.6zm132.2 170c-36.8 9.2-74-13.2-83.2-50-5-20 2-41 16.6-55.2 13.6-13.4 33.6-16.6 51.4-9.2 36.8 15.2 46.8 62 21.2 92.4-1.8 7.6-4 15.2-6 22zm-73.8-90.8c-7.6 0-14.8 4.2-18.6 11-3.8 6.8-3.8 15 0 21.8 3.8 6.8 11 11 18.6 11 7.6 0 14.8-4.2 18.6-11 3.8-6.8 3.8-15 0-21.8-3.8-6.8-11-11-18.6-11zm51.4 122.4v-31.2h15.2v31.2h21.2v14.4h-21.2v8.2c0 5.2 3 7.6 6.8 7.6 3.6 0 6.2-1.2 8.2-3.8v14.6c-4.6 3-9.8 4.6-15.2 4.6-6.6 0-11.8-2.2-15.4-6.4-3.6-4.2-5.4-10.2-5.4-18v-6.8h-14.4v-14.4h14.4l-5.8-31.2zm64.6-28.8v56.8h-15.2v-7.8c-3.6 5.6-9.2 9-16.4 9-5.2 0-9.6-1.8-12.6-5.2-3-3.6-4.6-8.6-4.6-15.2v-37.6h15.2v31.6c0 4.6 1 8 3 10 2 2 5.2 3 9.4 3 4.2 0 7.8-1.4 10.6-4.4 2.8-2.8 4.2-6.6 4.2-11.2v-29h6.4z"/></svg>
                    </div>
                    <span>百度识图</span>
                </a>
                
                <a href="https://lens.google.com/" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #4285f4;"><i class="fab fa-google"></i></div>
                    <span>Google Lens</span>
                </a>
                
                <a href="https://www.bing.com/visualsearch" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #008373;"><i class="fab fa-microsoft"></i></div>
                    <span>必应视觉</span>
                </a>
                
                <a href="https://yandex.com/images/" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #ff0000;"><i class="fab fa-yandex"></i></div>
                    <span>Yandex</span>
                </a>

                <a href="https://pic.sogou.com/" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #ff5500;"><i class="fas fa-search"></i></div>
                    <span>搜狗识图</span>
                </a>

                <a href="https://st.so.com/" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #19b955;"><i class="fas fa-shield-alt"></i></div>
                    <span>360识图</span>
                </a>

                <a href="https://tineye.com/" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #00aad2;"><i class="fas fa-eye"></i></div>
                    <span>TinEye</span>
                </a>

                <a href="https://saucenao.com/" target="_blank" class="simple-search-item" onclick="closeImageSearchModal()">
                    <div class="ss-icon" style="background: #2d3436;"><i class="fas fa-image"></i></div>
                    <span>SauceNAO</span>
                </a>
            </div>
        </div> </div>    

    
    <!-- 编辑网站模态框 -->
    <div class="modal" id="editBookmarkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">编辑网站</h2>
                <button class="close-modal" id="closeEditModalBtn">&times;</button>
            </div>
            <form id="editBookmarkForm">
                <div class="form-group">
                    <label class="form-label" for="editBookmarkName">网站名称 (最多10个字符)</label>
                    <input type="text" class="form-input" id="editBookmarkName" required maxlength="10">
                    <small style="color: #666; display: block; margin-top: 5px;">提示：最多显示8个汉字长度，完整名称可在鼠标悬停时查看</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="editBookmarkUrl">网站地址 (URL)</label>
                    <input type="text" class="form-input" id="editBookmarkUrl" required placeholder="https://example.com">
                    <small style="color: #666; display: block; margin-top: 5px;">提示：请输入完整的URL地址，如 https://www.google.com</small>
                </div>
                <div class="form-group">
                    <label class="form-label">选择图标</label>
                    <div class="icon-selector" id="iconSelector">
                        <!-- 图标将通过JS动态生成 -->
                    </div>
                    <small style="color: #666; display: block; margin-top: 5px;">提示：选择网站图标，如无法获取网站图标将使用此图标</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEditBtn">取消</button>
                    <button type="submit" class="btn btn-primary" id="saveEditBtn">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 编辑分类模态框 -->
    <div class="modal" id="editCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">编辑分类</h2>
                <button class="close-modal" id="closeCategoryModalBtn">&times;</button>
            </div>
            <form id="editCategoryForm">
                <div class="form-group">
                    <label class="form-label" for="editCategoryName">分类名称</label>
                    <input type="text" class="form-input" id="editCategoryName" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCategoryEditBtn">取消</button>
                    <button type="submit" class="btn btn-primary" id="saveCategoryEditBtn">保存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加分类模态框 -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">添加分类</h2>
                <button class="close-modal" id="closeAddCategoryModalBtn">&times;</button>
            </div>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label class="form-label" for="addCategoryName">分类名称</label>
                    <input type="text" class="form-input" id="addCategoryName" required placeholder="请输入新分类名称">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAddCategoryBtn">取消</button>
                    <button type="submit" class="btn btn-primary" id="saveAddCategoryBtn">添加</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 配色和背景模态框 -->
    <div class="modal" id="colorBgModal">
        <div class="modal-content color-bg-modal-content" style="max-width: 1200px !important; width: 90% !important;">
            <div class="modal-header">
                <h2 class="modal-title">配色与背景</h2>
                <button class="close-modal" id="closeColorBgModalBtn">&times;</button>
            </div>
            
            <div class="color-tabs">
                <button class="color-tab active" data-tab="skins">皮肤</button>
                <button class="color-tab" data-tab="colors">颜色</button>
                <button class="color-tab" data-tab="fonts">字体与标题</button>
            </div>
            
            <!-- 皮肤标签页 -->
            <div class="color-tab-content active" id="skinsTab">
                <div class="skin-upload-container">
                    <!-- 本地上传 -->
                    <div class="skin-upload-row">
                        <div class="skin-upload-input-group">
                            <span class="skin-upload-label">
                                <i class="fas fa-upload"></i> 本地上传
                            </span>
                            <input type="text" class="skin-upload-input" id="localPathDisplay" readonly placeholder="未选择图片" onclick="openUploadImageDialog()">
                        </div>
                        <button type="button" class="btn btn-primary skin-upload-btn" onclick="openUploadImageDialog()">选择图片</button>
                    </div>
                    
                    <!-- 图片URL -->
                    <div class="skin-upload-row">
                        <div class="skin-upload-input-group">
                            <span class="skin-upload-label">
                                <i class="fas fa-link"></i> 图片URL
                            </span>
                            <input type="text" class="skin-upload-input" id="customBgUrlInput" placeholder="粘贴图片链接...">
                        </div>
                        <button type="button" class="btn btn-primary skin-upload-btn" id="applyBgUrlBtn">应用链接</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="font-size: 12px; color: #888; margin-bottom: 10px;">预设皮肤</label>
                    <div class="skin-grid" id="skinGrid"></div>
                </div>

                <div class="form-actions" style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal(document.getElementById('colorBgModal'))">取消</button>
                    <button type="button" class="btn btn-primary" id="applySkinBtn" style="min-width: 120px; font-weight: bold;">确认应用皮肤</button>
                </div>
            </div>
            
            <!-- 颜色标签页 -->
            <div class="color-tab-content" id="colorsTab">
                <div class="form-group">
                    <label class="form-label">自定义颜色</label>
                    
                    <div class="color-picker-container">
                        <span class="color-label">所有文字颜色</span>
                        <input type="color" class="custom-color-input" id="textColorPicker" value="#ffffff">
                        <span class="color-value" id="textColorValue">#FFFFFF</span>
                    </div>
                    
                    <div class="color-picker-container">
                        <span class="color-label">分类边框颜色</span>
                        <input type="color" class="custom-color-input" id="borderColorPicker" value="#ffffff">
                        <span class="color-value" id="borderColorValue">#FFFFFF</span>
                    </div>
                    
                    <div class="color-picker-container">
                        <span class="color-label">按钮背景色</span>
                        <input type="color" class="custom-color-input" id="buttonBgColorPicker" value="#ffffff">
                        <span class="color-value" id="buttonBgColorValue">#FFFFFF</span>
                    </div>
                    
                    <div class="color-picker-container">
                        <span class="color-label">主色调</span>
                        <input type="color" class="custom-color-input" id="primaryColorPicker" value="#667eea">
                        <span class="color-value" id="primaryColorValue">#667EEA</span>
                    </div>
                    
                    <div class="color-picker-container">
                        <span class="color-label">副色调</span>
                        <input type="color" class="custom-color-input" id="secondaryColorPicker" value="#764ba2">
                        <span class="color-value" id="secondaryColorValue">#764BA2</span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelColorsBtn">取消</button>
                    <button type="button" class="btn btn-primary" id="applyColorsBtn">应用颜色</button>
                </div>
            </div>
            
            <!-- 字体与标题标签页 -->
            <div class="color-tab-content" id="fontsTab">
                <div class="title-input-row">
                    <div class="title-input-group">
                        <label class="form-label">标题文字</label>
                        <input type="text" class="form-input" id="editTitleText" placeholder="请输入导航页标题">
                        <small style="color: #666; display: block; margin-top: 5px;">提示：留空可删除标题文字</small>
                    </div>
                    <div class="title-input-group" style="flex: 2;">
                        <label class="form-label">副标题文字 (最多30字)</label>
                        <input type="text" class="form-input" id="editSubtitleText" placeholder="请输入副标题" maxlength="30">
                        <small style="color: #666; display: block; margin-top: 5px;">提示：留空可删除副标题文字，最多30个字符</small>
                    </div>
                </div>
                
                <div class="title-icon-row">
                    <div class="title-icon-upload-group">
                        <label class="form-label">标题图标</label>
                        <div style="text-align: center;">
                            <img id="titleIconPreview" class="title-icon-preview" src="" alt="图标预览" style="display: none; max-width: 80px;">
                        </div>
                        <input type="file" class="form-input" id="titleIconUpload" accept="image/*">
                    </div>
                    <div class="title-icon-remove-group">
                        <label class="form-label" style="visibility: hidden;">移除按钮</label>
                        <button type="button" class="btn btn-secondary" id="removeTitleIconBtn" style="width: 100%; margin-top: 8px; height: 40px;">移除图标</button>
                    </div>
                </div>
                
                <div class="font-size-container">
                    <div class="font-size-slider-container">
                        <div class="font-size-label">
                            <span>主标题大小</span>
                            <span class="font-size-value" id="titleFontSizeValue">48px</span>
                        </div>
                        <input type="range" class="form-input" id="titleFontSize" min="24" max="80" step="2" value="48" style="width: 100%;">
                    </div>
                    <div class="font-size-slider-container">
                        <div class="font-size-label">
                            <span>副标题大小</span>
                            <span class="font-size-value" id="subtitleFontSizeValue">24px</span>
                        </div>
                        <input type="range" class="form-input" id="subtitleFontSize" min="12" max="48" step="2" value="24" style="width: 100%;">
                    </div>
                </div>
                
                <div class="font-selector-container">
                    <div class="font-type-selector">
                        <button type="button" class="font-type-btn active" id="titleFontTypeBtn">主标题字体</button>
                        <button type="button" class="font-type-btn" id="subtitleFontTypeBtn">副标题字体</button>
                    </div>
                    
                    <div class="font-selector-title">
                        <i class="fas fa-font"></i> 字体选择
                    </div>
                    <div class="font-selector" id="fontSelector">
                        <!-- 字体将通过JS动态生成 -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelFontsBtn">取消</button>
                    <button type="button" class="btn btn-primary" id="applyFontsBtn">应用字体与标题</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 导入导出模态框 -->
    <div class="modal" id="importExportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">数据备份与恢复</h2>
                <button class="close-modal" id="closeImportExportModalBtn">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">导出数据</label>
                <p style="margin-bottom: 10px; color: #666;">点击下方按钮将当前所有数据导出为清晰文本文件</p>
                <button type="button" class="btn btn-primary" id="exportDataBtn" style="width: 100%;">
                    <i class="fas fa-download"></i> 导出数据到TXT文件
                </button>
                <small style="color: #666; display: block; margin-top: 10px;">导出格式：分类名称 + 网站名称 | 网址，方便编辑</small>
            </div>
            <div class="form-group">
                <label class="form-label">导入数据</label>
                <p style="margin-bottom: 10px; color: #666;">将编辑好的TXT文件内容粘贴到下方，或选择文件导入</p>
                
                <input type="file" class="form-input" id="importFileInput" accept=".txt" style="margin-bottom: 15px;">
                
                <div class="import-options" id="importOptions">
                    <div class="import-option" id="importOptionReplace">
                        <input type="radio" id="importTypeReplace" name="importType" value="replace" checked>
                        <div class="import-option-label">
                            <strong>全部替换</strong>
                            <div class="import-option-desc">清空现有数据，完全替换为导入的数据</div>
                        </div>
                    </div>
                    <div class="import-option" id="importOptionAdd">
                        <input type="radio" id="importTypeAdd" name="importType" value="add">
                        <div class="import-option-label">
                            <strong>增加分类</strong>
                            <div class="import-option-desc">保留现有数据，只添加新的分类和网站</div>
                        </div>
                    </div>
                </div>
                
                <div class="error-message" id="importError"></div>
                <small style="color: #666; display: block; margin-top: 5px;">提示：导入前会自动备份当前数据到"自动备份_当前时间.txt"</small>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelImportExportBtn">取消</button>
                <button type="button" class="btn btn-primary" id="importDataBtn">导入数据</button>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div class="modal" id="confirmDialog">
        <div class="confirm-dialog">
            <div class="confirm-title" id="confirmDialogTitle">确认操作</div>
            <div class="confirm-message" id="confirmDialogMessage">您确定要执行此操作吗？</div>
            <div class="confirm-actions">
                <button type="button" class="btn btn-secondary" id="confirmDialogCancelBtn">取消</button>
                <button type="button" class="btn btn-primary" id="confirmDialogConfirmBtn">确认</button>
            </div>
        </div>
    </div>

    <!-- 上传图片预览对话框 -->
    <div class="modal upload-preview-modal" id="uploadPreviewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">预览上传的图片</h2>
                <button class="close-modal" id="closeUploadPreviewBtn">&times;</button>
            </div>
            <div class="form-group">
                <div class="image-preview-container">
                    <img id="uploadPreviewImage" class="upload-preview-image" alt="图片预览">
                </div>
                <p style="text-align: center; color: #666; margin-bottom: 15px;">确认使用此图片作为背景吗？</p>
            </div>
            <div class="upload-preview-actions">
                <button type="button" class="btn btn-secondary" id="cancelUploadPreviewBtn">取消</button>
                <button type="button" class="btn btn-primary" id="confirmUploadPreviewBtn">确认</button>
            </div>
        </div>
    </div>

<div class="modal" id="loginModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h2 class="modal-title" id="loginModalTitle">账号登录</h2>
                <button class="close-modal" id="closeLoginModalBtn">×</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-input" id="usernameInput" required placeholder="请输入用户名" autocomplete="username">
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="password" class="form-input" id="passwordInput" required placeholder="请输入密码" autocomplete="current-password">
                </div>
                <div class="form-group" id="emailGroup" style="display:none;">
                    <label class="form-label">邮箱 (选填，用于找回)</label>
                    <input type="email" class="form-input" id="emailInput" placeholder="example@mail.com">
                </div>
                <div class="error-message" id="loginError" style="color: red; display:none; margin-bottom:10px;"></div>
                <div class="form-actions" style="flex-direction: column; gap: 15px;">
                    <button type="submit" class="btn btn-primary" id="loginSubmitBtn" style="width: 100%; padding: 12px;">登录并同步</button>
                    <div style="text-align: center; font-size: 14px; color: #666;">
                        <span id="toggleLoginModeText">还没有账号？</span>
                        <a href="#" id="toggleLoginModeBtn" style="color: var(--primary-color); text-decoration: none; font-weight: bold; margin-left: 5px;">去注册</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>

        // ✨✨✨ 第三步：在这里初始化 LeanCloud ✨✨✨
        const { Query, User } = AV;

        AV.init({
            appId: "08BLrj6itsBOdT7OSdxSZZ8Q-MdYXbMMI",       // 这里填你的 AppID
            appKey: "51CukflK39Mqa7qwZ1qHn8zj",     // 这里填你的 AppKey
            serverURL: "https://08blrj6i.api.lncldglobal.com"
        });

        // ... (下面是你原来的代码) ...
        // 搜索框提示语数组
        const searchPlaceholders = [
            "喂，是直接搜还是走个流程？",
            "告诉我你想翻谁的牌子～",
            "别愣着，敲点字吧！",
            "网址或咒语，速速报来。",
            "知识、八卦、好玩的，我全知道。",
            "您的专属任意门，请输入目的地。",
            "偷偷告诉我，你想搜什么？",
            "开始一场'即搜即走'的旅行。",
            "我准备好了，你呢？",
            "输入任意'愿望'，开始生成。",
            "启动一次关键词穿越。",
            "请输入目的地坐标（或关键词）。",
            "连接你与答案的最近节点。",
            "将你的好奇，编译为地址。",
            "思想发射井，等待指令。",
            "您的大脑外接搜索引擎，已就绪。",
            "从这里，打开下一个标签页。",
            "用几个字，撬动整个网络。",
            "当前路径：未定义。请输入新路径。",
            "问题接收器，正在待命。",
            "指尖所向，山海皆可往。",
            "在此处，投石问路。",
            "让一个词，带你抵达它的辽阔。",
            "心念一动，世界便为你铺路。",
            "方寸之间，自有天地。",
            "所有的远方，都始于此刻的光标。",
            "以词为舟，以网为海。",
            "书写你的下一个'抵达'。",
            "凝神，输入，然后抵达。",
            "每一次回车，都是启程。",
            "愣着干嘛？填它！",
            "知识、八卦、好玩的，我全知道。",
            "您的专属任意门，请输入目的地。",
            "悄悄话模式：你想搜什么？",
            "开始一场'即搜即走'的旅行。",
            "万事俱备，只差你的输入。",
            "输入任意'愿望'，开始生成。",
            "叮！这里接收所有问题。",
            "思想发射井，等待指令。",
            "您的大脑外接搜索引擎，已就绪。",
            "从这里，打开下一个标签页。",
            "用几个字，撬动整个网络。",
            "当前路径：未定义。请输入新路径。",
            "问题接收器，正在待命。",
            "向未知发送一个信号。",
            "启动你的信息火箭。",
            "心念一动，世界便为你铺路。",
            "方寸之间，自有天地。",
            "所有的远方，都始于此刻的光标。",
            "以词为舟，以网为海。",
            "书写你的下一个'抵达'。",
            "凝神，输入，然后抵达。",
            "近来搜得甚妙？",
            "心有一念，此处落键。",
            "但书一字，海内共鸣。",
            "欲叩何方门扉？",
            "忽有所得？书于此。",
            "游目骋怀，以此为棹。",
            "啪！你要搜个什么？",
            "万川映月，一月摄万川。",
            "搜山搜海，不如搜心。",
            "莫问搜否，但管敲来。"
        ];

        // ============================================
        // 优化版皮肤预设数据 - 使用提供的图片URL
        // ============================================
        const skinPresets = [
            {
                id: 'skin1',
                name: '像素怀旧',
                primaryColor: '#8b7355',
                secondaryColor: '#4a3c2a',
                bgType: 'image',
                bgValue: 'https://github.com/yujian-home/yujian-images/blob/main/8.jpg?raw=true',
                textColor: '#d9c7a8',
                borderColor: 'rgba(139, 115, 85, 0.6)',
                buttonBgColor: 'rgba(74, 60, 42, 0.4)',
                buttonHoverBgColor: 'rgba(139, 115, 85, 0.5)',
                decorClass: 'skin-decor-pixel',
                description: '复古游戏机风格，像素化视觉效果'
            },
            {
                id: 'skin2',
                name: '赛博科技',
                primaryColor: '#00e5ff',
                secondaryColor: '#ff4081',
                bgType: 'image',
                bgValue: 'https://github.com/yujian-home/yujian-images/blob/main/4.jpg?raw=true',
                textColor: '#00e5ff',
                borderColor: 'rgba(0, 229, 255, 0.6)',
                buttonBgColor: 'rgba(0, 229, 255, 0.2)',
                buttonHoverBgColor: 'rgba(255, 64, 129, 0.3)',
                decorClass: 'skin-decor-cyber',
                description: '霓虹未来感，赛博朋克与科技融合'
            },
            {
                id: 'skin3',
                name: '自然清新',
                primaryColor: '#4caf50',
                secondaryColor: '#81c784',
                bgType: 'image',
                bgValue: 'https://github.com/yujian-home/yujian-images/blob/main/7.jpg?raw=true',
                textColor: '#2e7d32',
                borderColor: 'rgba(76, 175, 80, 0.4)',
                buttonBgColor: 'rgba(129, 199, 132, 0.3)',
                buttonHoverBgColor: 'rgba(76, 175, 80, 0.4)',
                decorClass: 'skin-decor-nature',
                description: '绿色生态风格，清新自然氛围'
            },
            {
                id: 'skin4',
                name: '暗黑属性',
                primaryColor: '#888888',
                secondaryColor: '#666666',
                bgType: 'image',
                bgValue: 'https://github.com/yujian-home/yujian-images/blob/main/5.jpg?raw=true',
                textColor: '#e0e0e0',
                borderColor: 'rgba(136, 136, 136, 0.5)',
                buttonBgColor: 'rgba(136, 136, 136, 0.2)',
                buttonHoverBgColor: 'rgba(136, 136, 136, 0.3)',
                decorClass: 'skin-decor-dark',
                description: '深色神秘风格，护眼夜间模式'
            },
            {
                id: 'skin5',
                name: '青橙影调',
                primaryColor: '#00bcd4',
                secondaryColor: '#ff9800',
                bgType: 'image',
                bgValue: 'https://github.com/yujian-home/yujian-images/blob/main/6.jpg?raw=true',
                textColor: '#e0f7fa',
                borderColor: 'rgba(0, 188, 212, 0.6)',
                buttonBgColor: 'rgba(0, 188, 212, 0.2)',
                buttonHoverBgColor: 'rgba(255, 152, 0, 0.3)',
                decorClass: 'skin-decor-teal-orange',
                description: '电影感配色，青橙对比色调'
            },
            {
                id: 'skin6',
                name: '复古艺术',
                primaryColor: '#795548',
                secondaryColor: '#8d6e63',
                bgType: 'image',
                bgValue: 'https://github.com/yujian-home/yujian-images/blob/main/2.jpg?raw=true',
                textColor: '#4e342e',
                borderColor: 'rgba(121, 85, 72, 0.5)',
                buttonBgColor: 'rgba(121, 85, 72, 0.15)',
                buttonHoverBgColor: 'rgba(121, 85, 72, 0.25)',
                decorClass: 'skin-decor-vintage',
                description: '复古艺术风格，暖色调舒适感'
            }
        ];

        // 图片搜索引擎数据
        const imageSearchEnginesData = {
            baidu: {
                name: '百度识图',
                icon: 'fas fa-paw',
                url: 'https://graph.baidu.com/upload?from=pc',
                method: 'redirect'
            },
            google: {
                name: '谷歌搜图',
                icon: 'fab fa-google',
                url: 'https://images.google.com/searchbyimage?image_url=',
                method: 'url'
            },
            bing: {
                name: '必应搜图',
                icon: 'fab fa-microsoft',
                url: 'https://www.bing.com/images/search?q=imgurl:',
                method: 'url'
            },
            yandex: {
                name: 'Yandex搜图',
                icon: 'fab fa-yandex',
                url: 'https://yandex.com/images/search?url=',
                method: 'url'
            }
        };
        // 初始数据 - 修改默认皮肤为青橙影调
        const initialData = {
            categories: [
                { id: 1, name: '影音', order: 1 },
                { id: 2, name: '购物', order: 2 },
                { id: 3, name: '资讯', order: 3 },
                { id: 4, name: '社交', order: 4 },
                { id: 5, name: '生活', order: 5 },
                { id: 6, name: '工具', order: 6 },
                { id: 7, name: '趣站', order: 7 },
            ],
            bookmarks: [
                // 影音分类 - 24个网站
                { id: 1, name: '哔哩哔哩', url: 'https://www.bilibili.com', categoryId: 1, order: 1, customIcon: null },
                { id: 2, name: 'YouTube', url: 'https://www.youtube.com', categoryId: 1, order: 2, customIcon: null },
                { id: 3, name: '爱奇艺', url: 'https://www.iqiyi.com', categoryId: 1, order: 3, customIcon: null },
                { id: 4, name: '腾讯视频', url: 'https://v.qq.com', categoryId: 1, order: 4, customIcon: null },
                { id: 5, name: '优酷', url: 'https://www.youku.com', categoryId: 1, order: 5, customIcon: null },
                { id: 6, name: '芒果TV', url: 'https://www.mgtv.com', categoryId: 1, order: 6, customIcon: null },
                { id: 7, name: '网易云音乐', url: 'https://music.163.com', categoryId: 1, order: 7, customIcon: null },
                { id: 8, name: 'QQ音乐', url: 'https://y.qq.com', categoryId: 1, order: 8, customIcon: null },
                { id: 9, name: '酷狗音乐', url: 'https://www.kugou.com', categoryId: 1, order: 9, customIcon: null },
                { id: 10, name: '酷我音乐', url: 'https://www.kuwo.cn', categoryId: 1, order: 10, customIcon: null },
                { id: 11, name: '咪咕音乐', url: 'https://music.migu.cn', categoryId: 1, order: 11, customIcon: null },
                { id: 12, name: '抖音', url: 'https://www.douyin.com', categoryId: 1, order: 12, customIcon: null },
                { id: 13, name: '快手', url: 'https://www.kuaishou.com', categoryId: 1, order: 13, customIcon: null },
                { id: 14, name: '斗鱼', url: 'https://www.douyu.com', categoryId: 1, order: 14, customIcon: null },
                { id: 15, name: '虎牙直播', url: 'https://www.huya.com', categoryId: 1, order: 15, customIcon: null },
                { id: 16, name: 'AcFun', url: 'https://www.acfun.cn', categoryId: 1, order: 16, customIcon: null },
                { id: 17, name: '西瓜视频', url: 'https://www.ixigua.com', categoryId: 1, order: 17, customIcon: null },
                { id: 18, name: '喜马拉雅', url: 'https://www.ximalaya.com', categoryId: 1, order: 18, customIcon: null },
                { id: 19, name: '蜻蜓FM', url: 'https://www.qingting.fm', categoryId: 1, order: 19, customIcon: null },
                { id: 20, name: '猫耳FM', url: 'https://www.missevan.com', categoryId: 1, order: 20, customIcon: null },
                { id: 21, name: '全民K歌', url: 'https://kg.qq.com', categoryId: 1, order: 21, customIcon: null },
                { id: 22, name: '唱吧', url: 'https://changba.com', categoryId: 1, order: 22, customIcon: null },
                { id: 23, name: '网易LOOK直播', url: 'https://look.163.com', categoryId: 1, order: 23, customIcon: null },
                { id: 24, name: '微光', url: 'https://weiguang.com', categoryId: 1, order: 24, customIcon: null },
                
                // 购物分类 - 24个网站
                { id: 25, name: '淘宝', url: 'https://www.taobao.com', categoryId: 2, order: 1, customIcon: null },
                { id: 26, name: '京东', url: 'https://www.jd.com', categoryId: 2, order: 2, customIcon: null },
                { id: 27, name: '天猫', url: 'https://www.tmall.com', categoryId: 2, order: 3, customIcon: null },
                { id: 28, name: '拼多多', url: 'https://www.pinduoduo.com', categoryId: 2, order: 4, customIcon: null },
                { id: 29, name: '苏宁易购', url: 'https://www.suning.com', categoryId: 2, order: 5, customIcon: null },
                { id: 30, name: '亚马逊', url: 'https://www.amazon.cn', categoryId: 2, order: 6, customIcon: null },
                { id: 31, name: '唯品会', url: 'https://www.vip.com', categoryId: 2, order: 7, customIcon: null },
                { id: 32, name: '考拉海购', url: 'https://www.kaola.com', categoryId: 2, order: 8, customIcon: null },
                { id: 33, name: '当当网', url: 'https://www.dangdang.com', categoryId: 2, order: 9, customIcon: null },
                { id: 34, name: '小米商城', url: 'https://www.mi.com', categoryId: 2, order: 10, customIcon: null },
                { id: 35, name: '华为商城', url: 'https://www.vmall.com', categoryId: 2, order: 11, customIcon: null },
                { id: 36, name: 'Apple官网', url: 'https://www.apple.com/cn', categoryId: 2, order: 12, customIcon: null },
                { id: 37, name: '网易严选', url: 'https://you.163.com', categoryId: 2, order: 13, customIcon: null },
                { id: 38, name: '美团', url: 'https://www.meituan.com', categoryId: 2, order: 14, customIcon: null },
                { id: 39, name: '饿了么', url: 'https://www.ele.me', categoryId: 2, order: 15, customIcon: null },
                { id: 40, name: '大众点评', url: 'https://www.dianping.com', categoryId: 2, order: 16, customIcon: null },
                { id: 41, name: '携程', url: 'https://www.ctrip.com', categoryId: 2, order: 17, customIcon: null },
                { id: 42, name: '飞猪', url: 'https://www.fliggy.com', categoryId: 2, order: 18, customIcon: null },
                { id: 43, name: '去哪儿', url: 'https://www.qunar.com', categoryId: 2, order: 19, customIcon: null },
                { id: 44, name: '马蜂窝', url: 'https://www.mafengwo.cn', categoryId: 2, order: 20, customIcon: null },
                { id: 45, name: '12306', url: 'https://www.12306.cn', categoryId: 2, order: 21, customIcon: null },
                { id: 46, name: '途牛', url: 'https://www.tuniu.com', categoryId: 2, order: 22, customIcon: null },
                { id: 47, name: '同程', url: 'https://www.ly.com', categoryId: 2, order: 23, customIcon: null },
                { id: 48, name: '艺龙', url: 'https://www.elong.com', categoryId: 2, order: 24, customIcon: null },
                
                // 资讯分类 - 24个网站
                { id: 49, name: '今日头条', url: 'https://www.toutiao.com', categoryId: 3, order: 1, customIcon: null },
                { id: 50, name: '新浪新闻', url: 'https://news.sina.com.cn', categoryId: 3, order: 2, customIcon: null },
                { id: 51, name: '腾讯新闻', url: 'https://news.qq.com', categoryId: 3, order: 3, customIcon: null },
                { id: 52, name: '网易新闻', url: 'https://news.163.com', categoryId: 3, order: 4, customIcon: null },
                { id: 53, name: '搜狐新闻', url: 'https://news.sohu.com', categoryId: 3, order: 5, customIcon: null },
                { id: 54, name: '凤凰网', url: 'https://www.ifeng.com', categoryId: 3, order: 6, customIcon: null },
                { id: 55, name: '央视新闻', url: 'https://news.cctv.com', categoryId: 3, order: 7, customIcon: null },
                { id: 56, name: '人民网', url: 'https://www.people.com.cn', categoryId: 3, order: 8, customIcon: null },
                { id: 57, name: '新华网', url: 'https://www.xinhuanet.com', categoryId: 3, order: 9, customIcon: null },
                { id: 58, name: '环球网', url: 'https://www.huanqiu.com', categoryId: 3, order: 10, customIcon: null },
                { id: 59, name: '观察者网', url: 'https://www.guancha.cn', categoryId: 3, order: 11, customIcon: null },
                { id: 60, name: '虎嗅网', url: 'https://www.huxiu.com', categoryId: 3, order: 12, customIcon: null },
                { id: 61, name: '36氪', url: 'https://36kr.com', categoryId: 3, order: 13, customIcon: null },
                { id: 62, name: '界面新闻', url: 'https://www.jiemian.com', categoryId: 3, order: 14, customIcon: null },
                { id: 63, name: '澎湃新闻', url: 'https://www.thepaper.cn', categoryId: 3, order: 15, customIcon: null },
                { id: 64, name: '财新网', url: 'https://www.caixin.com', categoryId: 3, order: 16, customIcon: null },
                { id: 65, name: '第一财经', url: 'https://www.yicai.com', categoryId: 3, order: 17, customIcon: null },
                { id: 66, name: '华尔街见闻', url: 'https://wallstreetcn.com', categoryId: 3, order: 18, customIcon: null },
                { id: 67, name: '雪球', url: 'https://xueqiu.com', categoryId: 3, order: 19, customIcon: null },
                { id: 68, name: '东方财富', url: 'https://www.eastmoney.com', categoryId: 3, order: 20, customIcon: null },
                { id: 69, name: '同花顺', url: 'https://www.10jqka.com.cn', categoryId: 3, order: 21, customIcon: null },
                { id: 70, name: '大智慧', url: 'https://www.gw.com.cn', categoryId: 3, order: 22, customIcon: null },
                { id: 71, name: '金融界', url: 'https://www.jrj.com.cn', categoryId: 3, order: 23, customIcon: null },
                { id: 72, name: '和讯网', url: 'https://www.hexun.com', categoryId: 3, order: 24, customIcon: null },
                
                // 社交分类 - 24个网站
                { id: 73, name: '微信', url: 'https://weixin.qq.com', categoryId: 4, order: 1, customIcon: null },
                { id: 74, name: 'QQ', url: 'https://im.qq.com', categoryId: 4, order: 2, customIcon: null },
                { id: 75, name: '微博', url: 'https://weibo.com', categoryId: 4, order: 3, customIcon: null },
                { id: 76, name: '知乎', url: 'https://www.zhihu.com', categoryId: 4, order: 4, customIcon: null },
                { id: 77, name: '豆瓣', url: 'https://www.douban.com', categoryId: 4, order: 5, customIcon: null },
                { id: 78, name: '小红书', url: 'https://www.xiaohongshu.com', categoryId: 4, order: 6, customIcon: null },
                { id: 79, name: '贴吧', url: 'https://tieba.baidu.com', categoryId: 4, order: 7, customIcon: null },
                { id: 80, name: '人人网', url: 'https://www.renren.com', categoryId: 4, order: 8, customIcon: null },
                { id: 81, name: '陌陌', url: 'https://www.immomo.com', categoryId: 4, order: 9, customIcon: null },
                { id: 82, name: '探探', url: 'https://www.tantanapp.com', categoryId: 4, order: 10, customIcon: null },
                { id: 83, name: 'Soul', url: 'https://www.soulapp.cn', categoryId: 4, order: 11, customIcon: null },
                { id: 84, name: '脉脉', url: 'https://maimai.cn', categoryId: 4, order: 12, customIcon: null },
                { id: 85, name: '领英', url: 'https://www.linkedin.com', categoryId: 4, order: 13, customIcon: null },
                { id: 86, name: 'Facebook', url: 'https://www.facebook.com', categoryId: 4, order: 14, customIcon: null },
                { id: 87, name: 'Twitter', url: 'https://twitter.com', categoryId: 4, order: 15, customIcon: null },
                { id: 88, name: 'Instagram', url: 'https://www.instagram.com', categoryId: 4, order: 16, customIcon: null },
                { id: 89, name: 'Telegram', url: 'https://telegram.org', categoryId: 4, order: 17, customIcon: null },
                { id: 90, name: 'Discord', url: 'https://discord.com', categoryId: 4, order: 18, customIcon: null },
                { id: 91, name: 'Slack', url: 'https://slack.com', categoryId: 4, order: 19, customIcon: null },
                { id: 92, name: 'Teams', url: 'https://www.microsoft.com/teams', categoryId: 4, order: 20, customIcon: null },
                { id: 93, name: 'Zoom', url: 'https://zoom.us', categoryId: 4, order: 21, customIcon: null },
                { id: 94, name: 'Skype', url: 'https://www.skype.com', categoryId: 4, order: 22, customIcon: null },
                { id: 95, name: '钉钉', url: 'https://www.dingtalk.com', categoryId: 4, order: 23, customIcon: null },
                { id: 96, name: '企业微信', url: 'https://work.weixin.qq.com', categoryId: 4, order: 24, customIcon: null },
                
                // 生活分类 - 24个网站
                { id: 97, name: '美团外卖', url: 'https://waimai.meituan.com', categoryId: 5, order: 1, customIcon: null },
                { id: 98, name: '饿了么外卖', url: 'https://h5.ele.me', categoryId: 5, order: 2, customIcon: null },
                { id: 99, name: '大众点评', url: 'https://www.dianping.com', categoryId: 5, order: 3, customIcon: null },
                { id: 100, name: '58同城', url: 'https://www.58.com', categoryId: 5, order: 4, customIcon: null },
                { id: 101, name: '赶集网', url: 'https://www.ganji.com', categoryId: 5, order: 5, customIcon: null },
                { id: 102, name: '链家', url: 'https://www.lianjia.com', categoryId: 5, order: 6, customIcon: null },
                { id: 103, name: '贝壳找房', url: 'https://www.ke.com', categoryId: 5, order: 7, customIcon: null },
                { id: 104, name: '安居客', url: 'https://www.anjuke.com', categoryId: 5, order: 8, customIcon: null },
                { id: 105, name: '房天下', url: 'https://www.fang.com', categoryId: 5, order: 9, customIcon: null },
                { id: 106, name: '滴滴出行', url: 'https://www.didiglobal.com', categoryId: 5, order: 10, customIcon: null },
                { id: 107, name: '高德地图', url: 'https://www.amap.com', categoryId: 5, order: 11, customIcon: null },
                { id: 108, name: '百度地图', url: 'https://map.baidu.com', categoryId: 5, order: 12, customIcon: null },
                { id: 109, name: '腾讯地图', url: 'https://map.qq.com', categoryId: 5, order: 13, customIcon: null },
                { id: 110, name: '天气', url: 'https://weather.com.cn', categoryId: 5, order: 14, customIcon: null },
                { id: 111, name: '墨迹天气', url: 'https://www.moji.com', categoryId: 5, order: 15, customIcon: null },
                { id: 112, name: '万年历', url: 'https://www.wnl.com', categoryId: 5, order: 16, customIcon: null },
                { id: 113, name: '支付宝', url: 'https://www.alipay.com', categoryId: 5, order: 17, customIcon: null },
                { id: 114, name: '微信支付', url: 'https://pay.weixin.qq.com', categoryId: 5, order: 18, customIcon: null },
                { id: 115, name: '云闪付', url: 'https://www.unionpay.com', categoryId: 5, order: 19, customIcon: null },
                { id: 116, name: '京东金融', url: 'https://jr.jd.com', categoryId: 5, order: 20, customIcon: null },
                { id: 117, name: '蚂蚁财富', url: 'https://www.antfortune.com', categoryId: 5, order: 21, customIcon: null },
                { id: 118, name: '同花顺', url: 'https://www.10jqka.com.cn', categoryId: 5, order: 22, customIcon: null },
                { id: 119, name: '大智慧', url: 'https://www.gw.com.cn', categoryId: 5, order: 23, customIcon: null },
                { id: 120, name: '东方财富', url: 'https://www.eastmoney.com', categoryId: 5, order: 24, customIcon: null },
                
                // 工具分类 - 24个网站
                { id: 121, name: '百度网盘', url: 'https://pan.baidu.com', categoryId: 6, order: 1, customIcon: null },
                { id: 122, name: '腾讯微云', url: 'https://www.weiyun.com', categoryId: 6, order: 2, customIcon: null },
                { id: 123, name: '阿里云盘', url: 'https://www.aliyundrive.com', categoryId: 6, order: 3, customIcon: null },
                { id: 124, name: '坚果云', url: 'https://www.jianguoyun.com', categoryId: 6, order: 4, customIcon: null },
                { id: 125, name: 'WPS', url: 'https://www.wps.cn', categoryId: 6, order: 5, customIcon: null },
                { id: 126, name: 'Office', url: 'https://www.office.com', categoryId: 6, order: 6, customIcon: null },
                { id: 127, name: '石墨文档', url: 'https://shimo.im', categoryId: 6, order: 7, customIcon: null },
                { id: 128, name: '腾讯文档', url: 'https://docs.qq.com', categoryId: 6, order: 8, customIcon: null },
                { id: 129, name: '印象笔记', url: 'https://www.yinxiang.com', categoryId: 6, order: 9, customIcon: null },
                { id: 130, name: '有道云笔记', url: 'https://note.youdao.com', categoryId: 6, order: 10, customIcon: null },
                { id: 131, name: 'Notion', url: 'https://www.notion.so', categoryId: 6, order: 11, customIcon: null },
                { id: 132, name: '语雀', url: 'https://www.yuque.com', categoryId: 6, order: 12, customIcon: null },
                { id: 133, name: 'ProcessOn', url: 'https://www.processon.com', categoryId: 6, order: 13, customIcon: null },
                { id: 134, name: '幕布', url: 'https://mubu.com', categoryId: 6, order: 14, customIcon: null },
                { id: 135, name: 'Xmind', url: 'https://www.xmind.cn', categoryId: 6, order: 15, customIcon: null },
                { id: 136, name: 'MindMaster', url: 'https://www.edrawsoft.cn/mindmaster', categoryId: 6, order: 16, customIcon: null },
                { id: 137, name: 'Canva', url: 'https://www.canva.cn', categoryId: 6, order: 17, customIcon: null },
                { id: 138, name: '稿定设计', url: 'https://www.gaoding.com', categoryId: 6, order: 18, customIcon: null },
                { id: 139, name: 'Figma', url: 'https://www.figma.com', categoryId: 6, order: 19, customIcon: null },
                { id: 140, name: '蓝湖', url: 'https://lanhuapp.com', categoryId: 6, order: 20, customIcon: null },
                { id: 141, name: '墨刀', url: 'https://modao.cc', categoryId: 6, order: 21, customIcon: null },
                { id: 142, name: 'Axure', url: 'https://www.axure.com', categoryId: 6, order: 22, customIcon: null },
                { id: 143, name: 'Sketch', url: 'https://www.sketch.com', categoryId: 6, order: 23, customIcon: null },
                { id: 144, name: 'Photoshop', url: 'https://www.adobe.com/products/photoshop.html', categoryId: 6, order: 24, customIcon: null },
                
                // 趣站分类 - 24个网站
                { id: 145, name: 'B站', url: 'https://www.bilibili.com', categoryId: 7, order: 1, customIcon: null },
                { id: 146, name: 'AcFun', url: 'https://www.acfun.cn', categoryId: 7, order: 2, customIcon: null },
                { id: 147, name: '抖音', url: 'https://www.douyin.com', categoryId: 7, order: 3, customIcon: null },
                { id: 148, name: '快手', url: 'https://www.kuaishou.com', categoryId: 7, order: 4, customIcon: null },
                { id: 149, name: '虎牙', url: 'https://www.huya.com', categoryId: 7, order: 5, customIcon: null },
                { id: 150, name: '斗鱼', url: 'https://www.douyu.com', categoryId: 7, order: 6, customIcon: null },
                { id: 151, name: '喜马拉雅', url: 'https://www.ximalaya.com', categoryId: 7, order: 7, customIcon: null },
                { id: 152, name: '蜻蜓FM', url: 'https://www.qingting.fm', categoryId: 7, order: 8, customIcon: null },
                { id: 153, name: '网易云音乐', url: 'https://music.163.com', categoryId: 7, order: 9, customIcon: null },
                { id: 154, name: 'QQ音乐', url: 'https://y.qq.com', categoryId: 7, order: 10, customIcon: null },
                { id: 155, name: '酷狗音乐', url: 'https://www.kugou.com', categoryId: 7, order: 11, customIcon: null },
                { id: 156, name: '酷我音乐', url: 'https://www.kuwo.cn', categoryId: 7, order: 12, customIcon: null },
                { id: 157, name: '咪咕音乐', url: 'https://music.migu.cn', categoryId: 7, order: 13, customIcon: null },
                { id: 158, name: '全民K歌', url: 'https://kg.qq.com', categoryId: 7, order: 14, customIcon: null },
                { id: 159, name: '唱吧', url: 'https://changba.com', categoryId: 7, order: 15, customIcon: null },
                { id: 160, name: '汽水音乐', url: 'https://music.qishui.com', categoryId: 7, order: 16, customIcon: null },
                { id: 161, name: 'Spotify', url: 'https://www.spotify.com', categoryId: 7, order: 17, customIcon: null },
                { id: 162, name: 'Apple Music', url: 'https://music.apple.com', categoryId: 7, order: 18, customIcon: null },
                { id: 163, name: 'YouTube Music', url: 'https://music.youtube.com', categoryId: 7, order: 19, customIcon: null },
                { id: 164, name: 'TikTok', url: 'https://www.tiktok.com', categoryId: 7, order: 20, customIcon: null },
                { id: 165, name: 'Instagram', url: 'https://www.instagram.com', categoryId: 7, order: 21, customIcon: null },
                { id: 166, name: 'Pinterest', url: 'https://www.pinterest.com', categoryId: 7, order: 22, customIcon: null },
                { id: 167, name: 'Reddit', url: 'https://www.reddit.com', categoryId: 7, order: 23, customIcon: null },
                { id: 168, name: 'Twitch', url: 'https://www.twitch.tv', categoryId: 7, order: 24, customIcon: null },
            ],
            settings: {
                backgroundType: 'image',
                backgroundValue: 'https://github.com/yujian-home/yujian-images/blob/main/6.jpg?raw=true',
                primaryColor: '#00bcd4',
                secondaryColor: '#ff9800',
                pageTitle: '',
                pageSubtitle: '每一次与过往照面，都是为了与未来更好地遇见。',
                pageTitleIcon: '',
                pageTitleFontSize: '48px',
                pageSubtitleFontSize: '24px',
                pageTitleFont: 'Pacifico, cursive',
                pageSubtitleFont: "'Long Cang', cursive",
                searchEngine: 'google',
                textColor: '#e0f7fa',
                borderColor: 'rgba(0, 188, 212, 0.6)',
                buttonBgColor: 'rgba(0, 188, 212, 0.2)',
                buttonHoverBgColor: 'rgba(255, 152, 0, 0.3)',
                rowsPerCategory: 4,
                imageSearchEngine: 'baidu',
                currentSkin: 'skin5'
            }
        };

        // 状态管理
let state = {
    // 使用 initialData 的副本进行初始化，保证页面一打开就有数据
    categories: [...initialData.categories],
    bookmarks: [...initialData.bookmarks],
    settings: {...initialData.settings}, 
    currentCategory: null,
            editingBookmarkId: null,
            editingCategoryId: null,
            selectedSkin: null,
            editMode: false,
            showSettingsMenu: false,
            searchEngines: {
                // 1. Google (彩色 SVG)
                google: { 
                    name: '谷歌', 
                    iconHtml: `<svg viewBox="0 0 24 24" width="26" height="26" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>`,
                    color: '#4285f4', 
                    url: 'https://www.google.com/search?q=' 
                },
                
                // 2. 百度 (已换回：经典熊掌)
                baidu: { 
                    name: '百度', 
                    icon: 'fas fa-paw',  // 换回了 FontAwesome 的熊掌图标
                    color: '#2932e1',    // 百度蓝
                    url: 'https://www.baidu.com/s?wd=' 
                },
                
                // 3. 必应
                bing: { name: '必应', icon: 'fab fa-microsoft', color: '#008373', url: 'https://cn.bing.com/search?q=' },
                
                // 4. 360
                so: { name: '360', icon: 'fas fa-shield-alt', color: '#19b955', url: 'https://www.so.com/s?q=' },
                
                // 5. 知乎
                zhihu: { name: '知乎', icon: 'fab fa-zhihu', color: '#0084ff', url: 'https://www.zhihu.com/search?type=content&q=' },
                
                // 6. 微博
                weibo: { name: '微博', icon: 'fab fa-weibo', color: '#e6162d', url: 'https://s.weibo.com/weibo?q=' },
                
                // 7. B站
                bilibili: { name: 'B站', icon: 'fab fa-bilibili', color: '#fb7299', url: 'https://search.bilibili.com/all?keyword=' },
                
                // 8. YouTube
                youtube: { name: 'YouTube', icon: 'fab fa-youtube', color: '#ff0000', url: 'https://www.youtube.com/results?search_query=' },
                
                // 9. 小红书
                xiaohongshu: { name: '小红书', icon: 'fas fa-heart', color: '#ff2442', url: 'https://www.xiaohongshu.com/search_result?keyword=' },
                
                // 10. 豆瓣
                douban: { name: '豆瓣', icon: 'fas fa-seedling', color: '#007722', url: 'https://www.douban.com/search?q=' },
                
                // 11. GitHub
                github: { name: 'GitHub', icon: 'fab fa-github', color: '#333333', url: 'https://github.com/search?q=' },
                
                // 12. 秘塔AI
                metaso: { name: '秘塔AI', icon: 'fas fa-brain', color: '#5b21b6', url: 'https://metaso.cn/?q=' },
                
                // 13. 搜狗
                sogou: { name: '搜狗', icon: 'fas fa-search', color: '#ff5500', url: 'https://www.sogou.com/web?query=' },

                // 14. DuckDuckGo
                duckduckgo: { name: 'DuckGo', icon: 'fas fa-search', color: '#de5833', url: 'https://duckduckgo.com/?q=' },

                // 15. Yandex
                yandex: { name: 'Yandex', icon: 'fab fa-yandex', color: '#ff0000', url: 'https://yandex.com/search/?text=' },
                
                // 16. 网易云
                netease: { name: '网易云', icon: 'fas fa-music', color: '#e60026', url: 'https://music.163.com/#/search/m/?s=' }
            },
            faviconCache: {},
            currentAction: null,
            settingsBtnMode: 'settings',
            defaultIcons: [
                { class: 'fas fa-search icon-search', category: '搜索' },
                { class: 'fab fa-google icon-search', category: '搜索' },
                { class: 'fas fa-globe icon-search', category: '搜索' },
                { class: 'fab fa-youtube icon-video', category: '视频' },
                { class: 'fab fa-bilibili icon-video', category: '视频' },
                { class: 'fab fa-facebook icon-social', category: '社交' },
                { class: 'fab fa-twitter icon-social', category: '社交' },
                { class: 'fab fa-weixin icon-social', category: '社交' },
                { class: 'fas fa-shopping-cart icon-shopping', category: '购物' },
                { class: 'fab fa-amazon icon-shopping', category: '购物' },
                { class: 'fab fa-alipay icon-finance', category: '金融' },
                { class: 'fas fa-plane icon-travel', category: '旅行' },
                { class: 'fas fa-hotel icon-travel', category: '旅行' },
                { class: 'fas fa-briefcase icon-work', category: '工作' },
                { class: 'fas fa-graduation-cap icon-education', category: '教育' },
                { class: 'fas fa-gamepad icon-games', category: '游戏' },
                { class: 'fas fa-music icon-music', category: '音乐' },
                { class: 'fas fa-film icon-video', category: '视频' },
                { class: 'fas fa-newspaper icon-news', category: '新闻' },
                { class: 'fas fa-wrench icon-tools', category: '工具' },
                { class: 'fas fa-utensils icon-food', category: '美食' },
                { class: 'fas fa-heartbeat icon-health', category: '健康' },
                { class: 'fas fa-code icon-tech', category: '技术' },
                { class: 'fas fa-futbol icon-sports', category: '体育' },
                { class: 'fas fa-cloud-sun icon-weather', category: '天气' },
                { class: 'fas fa-book icon-books', category: '书籍' },
                { class: 'fas fa-palette icon-art', category: '艺术' },
                { class: 'fas fa-camera icon-art', category: '艺术' }
            ],
            draggingCategoryId: null,
            draggingBookmarkId: null,
            titleIconPreview: null,
            fontLibrary: [
                { name: '圆润体', value: 'Pacifico, cursive', family: 'Pacifico' },
                { name: '手写体', value: "'Dancing Script', cursive", family: 'Dancing Script' },
                { name: '衬线体', value: "'Playfair Display', serif", family: 'Playfair Display' },
                { name: '现代体', value: "'Montserrat', sans-serif", family: 'Montserrat' },
                { name: '简洁体', value: "'Roboto', sans-serif", family: 'Roboto' },
                { name: '手写2体', value: "'Caveat', cursive", family: 'Caveat' },
                { name: '阴影体', value: "'Shadows Into Light', cursive", family: 'Shadows Into Light' },
                { name: '典雅体', value: "'Fredericka the Great', cursive", family: 'Fredericka the Great' },
                { name: '打字机体', value: "'Special Elite', cursive", family: 'Special Elite' },
                { name: '龙藏体', value: "'Long Cang', cursive", family: 'Long Cang' },
                { name: '思源黑体', value: "'Noto Sans SC', sans-serif", family: 'Noto Sans SC' },
                { name: '站酷小微', value: "'ZCOOL XiaoWei', serif", family: 'ZCOOL XiaoWei' },
                { name: '站酷青楷', value: "'ZCOOL QingKe HuangYou', sans-serif", family: 'ZCOOL QingKe HuangYou' },
                { name: '马善政体', value: "'Ma Shan Zheng', cursive", family: 'Ma Shan Zheng' },
                { name: '刘剑毛笔', value: "'Liu Jian Mao Cao', cursive", family: 'Liu Jian Mao Cao' },
                { name: '楷体', value: "'KaiTi', cursive", family: 'KaiTi' },
                { name: '宋体', value: "'SimSun', serif", family: 'SimSun' },
                { name: '微软雅黑', value: "'Microsoft YaHei', sans-serif", family: 'Microsoft YaHei' },
                { name: 'Arial体', value: 'Arial, sans-serif', family: 'Arial' },
                { name: 'Times体', value: "'Times New Roman', serif", family: 'Times New Roman' }
            ],
            importType: 'replace',
            imageSearch: {
                selectedEngine: 'baidu',
                uploadedImage: null,
                imageUrl: '',
                imageFile: null
            },
            fontEditMode: 'title',
            dragTargetIndex: -1,
            uploadedImagePreview: null,
            isUploadingBackground: false
        };

        // DOM元素
        const elements = {
            mainContainer: document.getElementById('mainContainer'),
            categoriesContainer: document.getElementById('categoriesContainer'),
            bookmarksContainer: document.getElementById('bookmarksContainer'),
            editBookmarkModal: document.getElementById('editBookmarkModal'),
            editCategoryModal: document.getElementById('editCategoryModal'),
            addCategoryModal: document.getElementById('addCategoryModal'),
            colorBgModal: document.getElementById('colorBgModal'),
            importExportModal: document.getElementById('importExportModal'),
            imageSearchModal: document.getElementById('imageSearchModal'),
            decorativeLayer: document.getElementById('decorativeLayer'),
            backgroundImage: document.getElementById('backgroundImage'),
            pageTitle: document.getElementById('pageTitle'),
            pageSubtitle: document.getElementById('pageSubtitle'),
            searchInput: document.getElementById('searchInput'),
            currentEngine: document.getElementById('currentEngine'),
            engineGrid: document.getElementById('engineGrid'),
            searchBtn: document.getElementById('searchBtn'),
            imageSearchBtn: document.getElementById('imageSearchBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsMenu: document.getElementById('settingsMenu'),
            customizeBtn: document.getElementById('customizeBtn'),
            colorBgBtn: document.getElementById('colorBgBtn'),
            importExportBtn: document.getElementById('importExportBtn'),
            closeImportExportModalBtn: document.getElementById('closeImportExportModalBtn'),
            exportDataBtn: document.getElementById('exportDataBtn'),
            importFileInput: document.getElementById('importFileInput'),
            importDataBtn: document.getElementById('importDataBtn'),
            cancelImportExportBtn: document.getElementById('cancelImportExportBtn'),
            importError: document.getElementById('importError'),
            dragHint: document.getElementById('dragHint'),
            iconSelector: document.getElementById('iconSelector'),
            titleIconPreview: document.getElementById('titleIconPreview'),
            titleIconUpload: document.getElementById('titleIconUpload'),
            removeTitleIconBtn: document.getElementById('removeTitleIconBtn'),
            editTitleText: document.getElementById('editTitleText'),
            editSubtitleText: document.getElementById('editSubtitleText'),
            titleFontSize: document.getElementById('titleFontSize'),
            titleFontSizeValue: document.getElementById('titleFontSizeValue'),
            subtitleFontSize: document.getElementById('subtitleFontSize'),
            subtitleFontSizeValue: document.getElementById('subtitleFontSizeValue'),
            skinGrid: document.getElementById('skinGrid'),
            confirmDialog: document.getElementById('confirmDialog'),
            confirmDialogTitle: document.getElementById('confirmDialogTitle'),
            confirmDialogMessage: document.getElementById('confirmDialogMessage'),
            confirmDialogCancelBtn: document.getElementById('confirmDialogCancelBtn'),
            confirmDialogConfirmBtn: document.getElementById('confirmDialogConfirmBtn'),
            fontSelector: document.getElementById('fontSelector'),
            titleFontTypeBtn: document.getElementById('titleFontTypeBtn'),
            subtitleFontTypeBtn: document.getElementById('subtitleFontTypeBtn'),
            importOptions: document.getElementById('importOptions'),
            importOptionReplace: document.getElementById('importOptionReplace'),
            importOptionAdd: document.getElementById('importOptionAdd'),
            importTypeReplace: document.getElementById('importTypeReplace'),
            importTypeAdd: document.getElementById('importTypeAdd'),
            closeImageSearchModalBtn: document.getElementById('closeImageSearchModalBtn'),
            uploadPreviewModal: document.getElementById('uploadPreviewModal'),
            uploadPreviewImage: document.getElementById('uploadPreviewImage'),
            closeUploadPreviewBtn: document.getElementById('closeUploadPreviewBtn'),
            cancelUploadPreviewBtn: document.getElementById('cancelUploadPreviewBtn'),
            confirmUploadPreviewBtn: document.getElementById('confirmUploadPreviewBtn'),
            textColorPicker: document.getElementById('textColorPicker'),
            textColorValue: document.getElementById('textColorValue'),
            borderColorPicker: document.getElementById('borderColorPicker'),
            borderColorValue: document.getElementById('borderColorValue'),
            buttonBgColorPicker: document.getElementById('buttonBgColorPicker'),
            buttonBgColorValue: document.getElementById('buttonBgColorValue'),
            primaryColorPicker: document.getElementById('primaryColorPicker'),
            primaryColorValue: document.getElementById('primaryColorValue'),
            secondaryColorPicker: document.getElementById('secondaryColorPicker'),
            secondaryColorValue: document.getElementById('secondaryColorValue')
        };

        // ============================================
        // 修复版上传背景图片功能
        // ============================================

        // 打开上传图片对话框
        function openUploadImageDialog() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    if (!file.type.startsWith('image/')) {
                        alert('请选择图片文件！');
                        return;
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        alert('图片太大，请选择小于5MB的图片！');
                        return;
                    }
                    
                    const pathBox = document.getElementById('localPathDisplay');
                    if (pathBox) {
                        pathBox.value = file.name;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        state.uploadedImagePreview = event.target.result;
                        document.getElementById('uploadPreviewImage').src = event.target.result;
                        document.getElementById('uploadPreviewModal').style.display = 'flex';
                    };
                    reader.readAsDataURL(file);
                }
                setTimeout(() => {
                    if (document.body.contains(fileInput)) document.body.removeChild(fileInput);
                }, 1000);
            };
            
            document.body.appendChild(fileInput);
            fileInput.click();
        }

        // 应用上传的图片（只更换背景，不更换UI）
        function applyUploadedImage() {
            const imgElement = document.getElementById('uploadPreviewImage');
            const imageData = state.uploadedImagePreview || (imgElement ? imgElement.src : null);

            if (!imageData || imageData.length < 100) {
                alert('图片数据无效，请重试！');
                return;
            }

            try {
                // 只更换背景，保持当前UI样式
                state.settings.backgroundType = 'image';
                state.settings.backgroundValue = imageData;
                // 注意：不修改currentSkin，保持当前皮肤UI
                
                saveData(); 
                applySettings(); 
                
                const previewModal = document.getElementById('uploadPreviewModal');
                const bgModal = document.getElementById('colorBgModal');
                if (previewModal) previewModal.style.display = 'none';
                if (bgModal) bgModal.style.display = 'none';
                
                state.uploadedImagePreview = null;
                if (imgElement) imgElement.src = '';
                state.isUploadingBackground = false;
                
                alert('背景图片已成功应用！');

            } catch (error) {
                console.error(error);
                alert('程序出错：' + error.message);
            }
        }

        // ============================================
        // 修复版导入功能
        // ============================================

        // 重置导入窗口状态
        function resetImportModal() {
            elements.importFileInput.value = '';
            elements.importError.style.display = 'none';
            elements.importError.textContent = '';
            
            elements.importTypeReplace.checked = true;
            updateImportOptionSelection();
            state.importType = 'replace';
        }

        // 修复导入数据函数
        function importData() {
            const fileInput = elements.importFileInput;
            
            if (fileInput.files.length === 0) {
                showError(elements.importError, '请选择要导入的文件');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                try {
                    const importText = event.target.result;
                    const lines = importText.split('\n');
                    const newCategories = [];
                    const newBookmarks = [];
                    let currentCategory = null;
                    let categoryId = Math.max(...state.categories.map(c => c.id), 0) + 1;
                    let bookmarkId = Math.max(...state.bookmarks.map(b => b.id), 0) + 1;
                    
                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        
                        // 跳过空行
                        if (!trimmedLine) continue;
                        
                        // 检查是否为分类行（支持【分类】和[分类]格式）
                        const categoryMatch = trimmedLine.match(/^【(.+)】$/) || trimmedLine.match(/^\[(.+)\]$/);
                        
                        if (categoryMatch) {
                            const categoryName = categoryMatch[1].trim();
                            if (categoryName) {
                                currentCategory = {
                                    id: categoryId++,
                                    name: categoryName,
                                    order: newCategories.length + 1
                                };
                                newCategories.push(currentCategory);
                            }
                            continue;
                        }
                        
                        // 检查是否为书签行（支持 "网站名称 | 网址" 格式）
                        const bookmarkMatch = trimmedLine.match(/^(.+?)\s*[|｜]\s*(.+)$/);
                        
                        if (bookmarkMatch && currentCategory) {
                            const bookmarkName = bookmarkMatch[1].trim();
                            let bookmarkUrl = bookmarkMatch[2].trim();
                            
                            // 确保URL有协议
                            if (!bookmarkUrl.startsWith('http://') && !bookmarkUrl.startsWith('https://')) {
                                bookmarkUrl = 'https://' + bookmarkUrl;
                            }
                            
                            // 验证URL格式
                            try {
                                new URL(bookmarkUrl);
                            } catch (e) {
                                showError(elements.importError, `无效的URL格式: ${bookmarkUrl}`);
                                return;
                            }
                            
                            newBookmarks.push({
                                id: bookmarkId++,
                                name: bookmarkName,
                                url: bookmarkUrl,
                                categoryId: currentCategory.id,
                                order: newBookmarks.filter(b => b.categoryId === currentCategory.id).length + 1,
                                customIcon: null
                            });
                        }
                    }
                    
                    if (newCategories.length === 0 || newBookmarks.length === 0) {
                        showError(elements.importError, '未找到有效的分类或书签数据');
                        return;
                    }
                    
                    // 应用导入的数据
                    if (state.importType === 'replace') {
                        // 替换模式：完全替换现有数据
                        state.categories = newCategories;
                        state.bookmarks = newBookmarks;
                        
                        if (state.categories.length > 0) {
                            state.currentCategory = state.categories[0].id;
                        }
                    } else {
                        // 增加模式：保留现有数据，添加新的分类和书签
                        const existingCategoryNames = state.categories.map(c => c.name.toLowerCase());
                        const categoriesToAdd = newCategories.filter(c => !existingCategoryNames.includes(c.name.toLowerCase()));
                        
                        // 添加新分类
                        categoriesToAdd.forEach(category => {
                            state.categories.push({
                                ...category,
                                order: state.categories.length + 1
                            });
                        });
                        
                        // 添加新书签
                        newBookmarks.forEach(bookmark => {
                            const targetCategory = newCategories.find(c => c.id === bookmark.categoryId);
                            if (targetCategory) {
                                const actualCategory = state.categories.find(c => c.name.toLowerCase() === targetCategory.name.toLowerCase());
                                if (actualCategory) {
                                    state.bookmarks.push({
                                        ...bookmark,
                                        id: Math.max(...state.bookmarks.map(b => b.id), 0) + 1,
                                        categoryId: actualCategory.id,
                                        order: state.bookmarks.filter(b => b.categoryId === actualCategory.id).length + 1
                                    });
                                }
                            }
                        });
                    }
                    
                    ensureOrderFields();
                    saveData();
                    renderCategories();
                    renderBookmarks();
                    
                    closeModal(elements.importExportModal);
                    resetImportModal();
                    
                    alert(`数据导入成功！\n导入分类数: ${newCategories.length}\n导入书签数: ${newBookmarks.length}`);
                } catch (error) {
                    console.error('导入数据失败:', error);
                    showError(elements.importError, '数据格式错误，请检查导入的文件格式。支持格式：\n【分类名称】\n网站名称 | 网址');
                }
            };
            
            reader.onerror = function() {
                showError(elements.importError, '读取文件失败');
            };
            
            reader.readAsText(file);
        }

        // 自动备份当前数据
        function autoBackupCurrentData() {
            let backupText = '';
            
            const sortedCategories = [...state.categories].sort((a, b) => a.order - b.order);
            
            sortedCategories.forEach(category => {
                backupText += `【${category.name}】\n`;
                
                const categoryBookmarks = state.bookmarks
                    .filter(bookmark => bookmark.categoryId === category.id)
                    .sort((a, b) => a.order - b.order);
                
                categoryBookmarks.forEach(bookmark => {
                    backupText += `${bookmark.name} | ${bookmark.url}\n`;
                });
                
                backupText += '\n';
            });
            
            // 创建备份文件
            const blob = new Blob([backupText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `自动备份_${timestamp}.txt`;
            
            // 自动下载备份文件
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log(`已自动备份当前数据到: ${filename}`);
        }

        // ============================================
        // 其他核心函数
        // ============================================
        document.body.addEventListener('click', function(e) {
            const target = e.target.closest('#confirmUploadPreviewBtn');
            if (target) {
                console.log("检测到确认按钮点击 - 强制执行");
                e.preventDefault();
                e.stopPropagation();
                applyUploadedImage();
            }
        }, true);

        // ============================================
        // 🔐 登录/注册 交互逻辑
        // ============================================
        let isRegisterMode = false;

        function setupAuthEvents() {
            const loginBtn = document.getElementById('loginMenuBtn');
            const loginModal = document.getElementById('loginModal');
            const closeBtn = document.getElementById('closeLoginModalBtn');
            const toggleBtn = document.getElementById('toggleLoginModeBtn');
            const form = document.getElementById('loginForm');
            const menu = document.getElementById('settingsMenu');

            // 打开登录框
            if(loginBtn) {
                loginBtn.addEventListener('click', () => {
                    const user = AV.User.current();
                    if (user) {
                        if(confirm(`当前登录用户：${user.getUsername()}\n确定要退出登录吗？`)) {
                            AV.User.logOut();
                            location.reload(); // 刷新恢复本地数据
                        }
                    } else {
                        menu.classList.remove('show');
                        loginModal.style.display = 'flex';
                    }
                });
            }

            if(closeBtn) closeBtn.addEventListener('click', () => loginModal.style.display = 'none');

            // 切换注册/登录
            if(toggleBtn) {
                toggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    isRegisterMode = !isRegisterMode;
                    document.getElementById('loginModalTitle').textContent = isRegisterMode ? '注册新账号' : '账号登录';
                    document.getElementById('loginSubmitBtn').textContent = isRegisterMode ? '注册并同步当前数据' : '登录';
                    document.getElementById('toggleLoginModeText').textContent = isRegisterMode ? '已有账号？' : '还没有账号？';
                    toggleBtn.textContent = isRegisterMode ? '去登录' : '去注册';
                    document.getElementById('emailGroup').style.display = isRegisterMode ? 'block' : 'none';
                });
            }

            // 提交表单
            if(form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('usernameInput').value.trim();
                    const password = document.getElementById('passwordInput').value.trim();
                    const email = document.getElementById('emailInput').value.trim();
                    const errorBox = document.getElementById('loginError');
                    const submitBtn = document.getElementById('loginSubmitBtn');
                    
                    errorBox.style.display = 'none';
                    submitBtn.disabled = true;
                    submitBtn.textContent = '处理中...';

                    try {
                        if (isRegisterMode) {
                            // 注册
                            const user = new AV.User();
                            user.setUsername(username);
                            user.setPassword(password);
                            if(email) user.setEmail(email);
                            await user.signUp();
                            // 注册成功后，立即上传当前本地数据
                            await saveData(true);
                            alert('注册成功！您的数据已同步到云端。');
                        } else {
                            // 登录
                            await AV.User.logIn(username, password);
                            // 登录成功后，拉取云端数据
                            await loadData();
                        }
                        loginModal.style.display = 'none';
                        updateLoginButtonState(true);
                    } catch (error) {
                        errorBox.textContent = '操作失败: ' + (error.message || '未知错误');
                        errorBox.style.display = 'block';
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = isRegisterMode ? '注册并同步当前数据' : '登录';
                    }
                });
            }
        }

        function updateLoginButtonState(isLoggedIn) {
            const btn = document.getElementById('loginMenuBtn');
            if (!btn) return;
            if (isLoggedIn) {
                const user = AV.User.current();
                btn.innerHTML = `<i class="fas fa-user-check"></i> ${user.getUsername()} (点击退出)`;
                btn.style.color = '#4caf50'; // 绿色表示已登录
            } else {
                btn.innerHTML = `<i class="fas fa-sign-in-alt"></i> 登录 / 注册`;
                btn.style.color = 'var(--primary-color)';
            }
        }
        
        // 辅助函数：应用加载的数据
        function applyLoadedData(data) {
            state.categories = data.categories || initialData.categories;
            state.bookmarks = data.bookmarks || initialData.bookmarks;
            state.settings = data.settings || initialData.settings;
            // 确保设置完整
            if(!state.settings.currentSkin) state.settings.currentSkin = 'skin6';
            
            // 重新渲染页面
            renderCategories();
            renderBookmarks();
            applySettings();
            updateSearchEngineDisplay();
        }

        // 辅助函数：重置为默认
        function resetStateToDefault() {
            state.categories = [...initialData.categories];
            state.bookmarks = [...initialData.bookmarks];
            state.settings = {...initialData.settings};
        }

        // 初始化应用 (修复版)
        function initApp() {
            loadData();
            renderSearchEngines();
            renderCategories();
            applySettings();
            setupEventListeners();
            setupAuthEvents();
            
            // 确保第一个分类默认显示
            if (state.categories.length > 0) {
                state.currentCategory = state.categories[0].id;
                setActiveCategory(state.currentCategory, true);
                renderBookmarks();
            }
            
            updateSearchEngineDisplay();
            preloadFavicons();
            renderIconSelector();
            renderSkinGrid();
            setRandomSearchPlaceholder();
            setupColorPickers();
            setupFontSelectors();
            
            setupImportOptions();
            
            // 点击空白处关闭设置菜单
            document.addEventListener('click', (e) => {
                if (elements.settingsBtn && elements.settingsMenu && 
                    !elements.settingsBtn.contains(e.target) && 
                    !elements.settingsMenu.contains(e.target)) {
                    elements.settingsMenu.classList.remove('show');
                }
            });
        }

        // 应用皮肤（同时更换UI和背景）
        function applySkin() {
            if (!state.selectedSkin) {
                alert('请先选择一个皮肤');
                return;
            }
            
            // 应用完整的皮肤设置（UI+背景）
            state.settings.primaryColor = state.selectedSkin.primaryColor;
            state.settings.secondaryColor = state.selectedSkin.secondaryColor;
            state.settings.textColor = state.selectedSkin.textColor;
            state.settings.borderColor = state.selectedSkin.borderColor;
            state.settings.buttonBgColor = state.selectedSkin.buttonBgColor;
            state.settings.buttonHoverBgColor = state.selectedSkin.buttonHoverBgColor;
            state.settings.currentSkin = state.selectedSkin.id;
            
            // 统一其他文字颜色
            state.settings.categoryColor = state.selectedSkin.textColor;
            state.settings.bookmarkColor = state.selectedSkin.textColor;
            
            // 应用皮肤的背景
            state.settings.backgroundType = state.selectedSkin.bgType;
            state.settings.backgroundValue = state.selectedSkin.bgValue;
            
            saveData();
            applySettings();
            closeModal(elements.colorBgModal);
            
            // 重新渲染皮肤网格以更新选中状态
            setTimeout(() => {
                renderSkinGrid();
            }, 100);
        }

        // 应用设置
        function applySettings() {
            const settings = state.settings;
            // 给 body 加标记，方便 CSS 针对不同皮肤做变形
            document.body.dataset.skin = settings.currentSkin; 
            
            if (settings.backgroundType === 'gradient') {
                document.body.style.background = settings.backgroundValue;
                elements.backgroundImage.style.display = 'none';
                document.body.classList.remove('no-texture');
            } else if (settings.backgroundType === 'image') {
                document.body.style.background = '';
                elements.backgroundImage.src = settings.backgroundValue;
                elements.backgroundImage.style.display = 'block';
                document.body.classList.add('no-texture');
            }
            
            document.documentElement.style.setProperty('--primary-color', settings.primaryColor);
            document.documentElement.style.setProperty('--secondary-color', settings.secondaryColor);
            document.documentElement.style.setProperty('--bg-color', settings.backgroundValue);
            document.documentElement.style.setProperty('--text-color', settings.textColor);
            document.documentElement.style.setProperty('--category-color', settings.textColor);
            document.documentElement.style.setProperty('--bookmark-color', settings.textColor);
            document.documentElement.style.setProperty('--border-color', settings.borderColor);
            document.documentElement.style.setProperty('--button-bg-color', settings.buttonBgColor);
            document.documentElement.style.setProperty('--button-hover-bg-color', settings.buttonHoverBgColor);
            document.documentElement.style.setProperty('--title-font', settings.pageTitleFont);
            document.documentElement.style.setProperty('--subtitle-font', settings.pageSubtitleFont);
            
            // 应用装饰层
            updateDecorativeLayer();
            
            if (settings.pageTitle) {
                elements.pageTitle.textContent = settings.pageTitle;
                elements.pageTitle.style.fontSize = settings.pageTitleFontSize;
                elements.pageTitle.style.fontFamily = settings.pageTitleFont;
                
                if (settings.pageTitleIcon) {
                    const existingIcon = elements.pageTitle.querySelector('.page-title-icon');
                    if (existingIcon) {
                        existingIcon.remove();
                    }
                    
                    const icon = document.createElement('img');
                    icon.className = 'page-title-icon';
                    icon.src = settings.pageTitleIcon;
                    icon.alt = '标题图标';
                    elements.pageTitle.prepend(icon);
                    
                    const fontSize = parseInt(settings.pageTitleFontSize);
                    icon.style.width = `${fontSize * 1.2}px`;
                    icon.style.height = `${fontSize * 1.2}px`;
                } else {
                    const existingIcon = elements.pageTitle.querySelector('.page-title-icon');
                    if (existingIcon) {
                        existingIcon.remove();
                    }
                }
            } else {
                elements.pageTitle.textContent = '';
            }
            
            if (settings.pageSubtitle) {
                elements.pageSubtitle.textContent = settings.pageSubtitle;
                elements.pageSubtitle.style.fontSize = settings.pageSubtitleFontSize;
                elements.pageSubtitle.style.fontFamily = settings.pageSubtitleFont;
                elements.pageSubtitle.style.whiteSpace = 'nowrap';
                elements.pageSubtitle.style.overflow = 'hidden';
                elements.pageSubtitle.style.textOverflow = 'ellipsis';
            } else {
                elements.pageSubtitle.textContent = '';
            }
            
            // 智能颜色适配
            applyColorAdaptation();
        }

        // 更新装饰层
        function updateDecorativeLayer() {
            // 保持这里为空
        }

        // 设置事件监听器 (修复版)
        function setupEventListeners() {
            // 激活URL背景应用
            const applyUrlBtn = document.getElementById('applyBgUrlBtn');
            if (applyUrlBtn) {
                applyUrlBtn.onclick = () => {
                    const url = document.getElementById('customBgUrlInput').value.trim();
                    if (!url) return alert('请输入链接');
                    // 只更换背景，不更换UI
                    state.settings.backgroundType = 'image';
                    state.settings.backgroundValue = url;
                    // 注意：不修改currentSkin，保持当前皮肤UI
                    saveData(); 
                    applySettings(); 
                    alert('背景已成功更新');
                };
            }
            // 1. 搜索引擎下拉菜单
            if (elements.currentEngine) {
                elements.currentEngine.addEventListener('click', (e) => {
                    if (state.editMode) return;
                    e.stopPropagation();
                    elements.engineGrid.classList.toggle('show');
                });
            }
            
            document.addEventListener('click', (e) => {
                if (elements.currentEngine && elements.engineGrid && 
                    !elements.currentEngine.contains(e.target) && 
                    !elements.engineGrid.contains(e.target)) {
                    elements.engineGrid.classList.remove('show');
                }
            });
            
            // 2. 搜索按钮
            if (elements.searchBtn) elements.searchBtn.addEventListener('click', performSearch);
            if (elements.searchInput) {
                elements.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            }
            
            // 3. 识图按钮
            if (elements.imageSearchBtn) {
                elements.imageSearchBtn.addEventListener('click', openImageSearchModal);
            }
            
            // 4. 设置按钮
            if (elements.settingsBtn) {
                elements.settingsBtn.addEventListener('click', (e) => {
                    if (state.editMode) {
                        exitEditMode();
                    } else {
                        e.stopPropagation();
                        elements.settingsMenu.classList.toggle('show');
                    }
                });
            }
            
            // 5. 菜单项
            if (elements.customizeBtn) {
                elements.customizeBtn.addEventListener('click', () => {
                    elements.settingsMenu.classList.remove('show');
                    toggleEditMode();
                });
            }
            
            if (elements.colorBgBtn) {
                elements.colorBgBtn.addEventListener('click', () => {
                    elements.settingsMenu.classList.remove('show');
                    openColorBgModal(); 
                });
            }
            
            if (elements.importExportBtn) {
                elements.importExportBtn.addEventListener('click', () => {
                    elements.settingsMenu.classList.remove('show');
                    resetImportModal();
                    elements.importExportModal.style.display = 'flex';
                });
            }
            
            // 6. 关闭/取消按钮
            if (elements.closeImportExportModalBtn) elements.closeImportExportModalBtn.addEventListener('click', () => closeModal(elements.importExportModal));
            if (elements.cancelImportExportBtn) elements.cancelImportExportBtn.addEventListener('click', () => closeModal(elements.importExportModal));
            
            if (elements.closeImageSearchModalBtn) {
                elements.closeImageSearchModalBtn.addEventListener('click', () => closeModal(elements.imageSearchModal));
            }
            
            if (elements.closeUploadPreviewBtn) {
                elements.closeUploadPreviewBtn.addEventListener('click', () => {
                    closeModal(elements.uploadPreviewModal);
                    state.isUploadingBackground = false;
                });
            }
            if (elements.cancelUploadPreviewBtn) {
                elements.cancelUploadPreviewBtn.addEventListener('click', () => {
                    closeModal(elements.uploadPreviewModal);
                    state.isUploadingBackground = false;
                });
            }
            if (elements.confirmUploadPreviewBtn) {
                elements.confirmUploadPreviewBtn.addEventListener('click', applyUploadedImage);
            }

            // 7. 功能按钮
            if (elements.exportDataBtn) elements.exportDataBtn.addEventListener('click', exportData);
            if (elements.importDataBtn) elements.importDataBtn.addEventListener('click', importData);
            
            const applySkinBtn = document.getElementById('applySkinBtn');
            if (applySkinBtn) applySkinBtn.addEventListener('click', applySkin);
            
            const applyColorsBtn = document.getElementById('applyColorsBtn');
            if (applyColorsBtn) applyColorsBtn.addEventListener('click', applyColors);
            
            const applyFontsBtn = document.getElementById('applyFontsBtn');
            if (applyFontsBtn) applyFontsBtn.addEventListener('click', applyFonts);

            // 8. 颜色标签页
            document.querySelectorAll('.color-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    document.querySelectorAll('.color-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.color-tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });

            // 9. 标题图标
            if (elements.titleIconUpload) {
                elements.titleIconUpload.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            elements.titleIconPreview.src = event.target.result;
                            elements.titleIconPreview.style.display = 'block';
                            state.titleIconPreview = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            if (elements.removeTitleIconBtn) {
                elements.removeTitleIconBtn.addEventListener('click', () => {
                    elements.titleIconPreview.src = '';
                    elements.titleIconPreview.style.display = 'none';
                    state.titleIconPreview = null;
                    elements.titleIconUpload.value = '';
                });
            }

            // 10. 表单提交
            const editBookmarkForm = document.getElementById('editBookmarkForm');
            if(editBookmarkForm) editBookmarkForm.addEventListener('submit', saveBookmark);
            
            const editCategoryForm = document.getElementById('editCategoryForm');
            if(editCategoryForm) editCategoryForm.addEventListener('submit', saveCategory);
            
            const addCategoryForm = document.getElementById('addCategoryForm');
            if(addCategoryForm) addCategoryForm.addEventListener('submit', addCategory);

            // 11. 模态框通用关闭 - 修复：编辑网站和编辑分类模态框不允许点击外部关闭
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            if(cancelEditBtn) cancelEditBtn.addEventListener('click', () => closeModal(elements.editBookmarkModal));
            
            const cancelCategoryEditBtn = document.getElementById('cancelCategoryEditBtn');
            if(cancelCategoryEditBtn) cancelCategoryEditBtn.addEventListener('click', () => closeModal(elements.editCategoryModal));
            
            const cancelAddCategoryBtn = document.getElementById('cancelAddCategoryBtn');
            if(cancelAddCategoryBtn) cancelAddCategoryBtn.addEventListener('click', () => closeModal(elements.addCategoryModal));
            
            const closeColorBgModalBtn = document.getElementById('closeColorBgModalBtn');
            if(closeColorBgModalBtn) closeColorBgModalBtn.addEventListener('click', () => closeModal(elements.colorBgModal));
            
            const cancelColorsBtn = document.getElementById('cancelColorsBtn');
            if(cancelColorsBtn) cancelColorsBtn.addEventListener('click', () => closeModal(elements.colorBgModal));
            
            const cancelFontsBtn = document.getElementById('cancelFontsBtn');
            if(cancelFontsBtn) cancelFontsBtn.addEventListener('click', () => closeModal(elements.colorBgModal));

            // 12. 修改点击模态框外部关闭逻辑 - 编辑网站和编辑分类模态框不允许点击外部关闭
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    // 检查是否为编辑网站或编辑分类模态框
                    const modalId = e.target.id;
                    if (modalId !== 'editBookmarkModal' && modalId !== 'editCategoryModal' && modalId !== 'addCategoryModal') {
                        closeModal(e.target);
                        if (modalId === 'uploadPreviewModal') state.isUploadingBackground = false;
                    }
                }
            });
            
            // 13. 其他关闭按钮
            document.querySelectorAll('.close-modal').forEach(btn => {
                if (!btn.id.includes('ImportExport') && !btn.id.includes('ImageSearch') && !btn.id.includes('UploadPreview')) {
                    btn.addEventListener('click', () => {
                        const modal = btn.closest('.modal');
                        if (modal) closeModal(modal);
                    });
                }
            });
        }

        // 智能颜色适配函数
        function applyColorAdaptation() {
            // 获取背景色并判断深浅
            const bgColor = getBackgroundColor();
            const isDark = isColorDark(bgColor);
            
            // 如果用户已经自定义过颜色，就不自动调整
            if (state.settings.currentSkin === 'custom' || state.settings.currentSkin === 'custom-upload') {
                return;
            }
            
            // 根据背景深浅调整颜色
            if (isDark) {
                // 深色背景 - 使用浅色文字和边框
                if (!state.settings.textColor || state.settings.textColor === '#333333') {
                    state.settings.textColor = '#ffffff';
                    state.settings.borderColor = 'rgba(255, 255, 255, 0.4)';
                    state.settings.buttonBgColor = 'rgba(255, 255, 255, 0.15)';
                    state.settings.buttonHoverBgColor = 'rgba(255, 255, 255, 0.25)';
                }
            } else {
                // 浅色背景 - 使用深色文字和边框
                if (!state.settings.textColor || state.settings.textColor === '#ffffff') {
                    state.settings.textColor = '#333333';
                    state.settings.borderColor = 'rgba(0, 0, 0, 0.2)';
                    state.settings.buttonBgColor = 'rgba(0, 0, 0, 0.1)';
                    state.settings.buttonHoverBgColor = 'rgba(0, 0, 0, 0.2)';
                }
            }
            
            // 更新CSS变量
            document.documentElement.style.setProperty('--text-color', state.settings.textColor);
            document.documentElement.style.setProperty('--border-color', state.settings.borderColor);
            document.documentElement.style.setProperty('--button-bg-color', state.settings.buttonBgColor);
            document.documentElement.style.setProperty('--button-hover-bg-color', state.settings.buttonHoverBgColor);
        }

        // 获取背景颜色
        function getBackgroundColor() {
            if (state.settings.backgroundType === 'gradient') {
                // 从渐变中提取第一个颜色
                const gradient = state.settings.backgroundValue;
                const match = gradient.match(/#[0-9a-fA-F]{6}/);
                return match ? match[0] : '#667eea';
            } else {
                // 图片背景，默认为深色
                return '#000000';
            }
        }

        // 判断颜色是否为深色
        function isColorDark(color) {
            // 将颜色转换为RGB
            let r, g, b;
            
            if (color.startsWith('#')) {
                r = parseInt(color.substr(1, 2), 16);
                g = parseInt(color.substr(3, 2), 16);
                b = parseInt(color.substr(5, 2), 16);
            } else if (color.startsWith('rgb')) {
                const rgb = color.match(/\d+/g);
                r = parseInt(rgb[0]);
                g = parseInt(rgb[1]);
                b = parseInt(rgb[2]);
            } else {
                // 默认返回深色
                return true;
            }
            
            // 计算亮度 (YIQ公式)
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            // 亮度小于128为深色
            return brightness < 128;
        }

// 1. 加载数据 (优先尝试从云端拉取)
        async function loadData() {
            // 显示简单的加载状态（可选）
            console.log('正在加载数据...');
            const user = AV.User.current();
            
            // 情况A：已登录，从云端拉取
            if (user) {
                updateLoginButtonState(true); 
                try {
                    const query = new AV.Query('UserNavData');
                    query.equalTo('owner', user);
                    const record = await query.first();

                    if (record) {
                        const cloudData = record.get('content');
                        console.log('☁️ 从云端加载数据成功');
                        applyLoadedData(cloudData);
                        return;
                    } else {
                        // 新用户（有账号但无数据），自动同步本地数据上去
                        console.log('☁️ 新用户，自动初始化云端数据');
                        await saveData(true); 
                    }
             } catch (error) {
            // === 修改开始：智能判断错误类型 ===
            
            // 如果错误码是 101 (Class不存在) 或者包含 404，说明是新用户，还没创建表
            // 这种情况我们不弹窗报错，而是默默记录一下
            if (error.code === 101 || error.message.includes('404') || error.message.includes("Class or object doesn't exists")) {
                console.log('☁️ 检测到是新用户（云端表 UserNavData 尚未创建），暂无数据，将使用默认配置。');
                // 这里什么都不用做，代码会自动继续往下执行，加载本地缓存或默认数据
            } else {
                // 只有遇到真正的网络问题或其他错误时，才弹窗打扰你
                console.error('云端加载严重错误:', error);
                alert('云端连接出错：' + error.message + '，已自动切换为本地模式');
            }
            // === 修改结束 ===
        }
            } else {
                updateLoginButtonState(false);
            }

            // 情况B：未登录或云端失败，加载本地
            const savedData = localStorage.getItem('navPageData');
            if (savedData) {
                try {
                    applyLoadedData(JSON.parse(savedData));
                } catch(e) { 
                    resetStateToDefault();
                }
            } else {
                resetStateToDefault();
                saveData(); // 保存初始数据到本地
            }
        }

        // 确保设置存在
        function ensureSettings() {
            const defaults = initialData.settings;
            if (!state.settings.rowsPerCategory) state.settings.rowsPerCategory = defaults.rowsPerCategory;
            if (!state.settings.textColor) state.settings.textColor = defaults.textColor;
            if (!state.settings.borderColor) state.settings.borderColor = defaults.borderColor;
            if (!state.settings.buttonBgColor) state.settings.buttonBgColor = defaults.buttonBgColor;
            if (!state.settings.buttonHoverBgColor) state.settings.buttonHoverBgColor = defaults.buttonHoverBgColor;
            if (!state.settings.pageTitleIcon) state.settings.pageTitleIcon = defaults.pageTitleIcon;
            if (!state.settings.pageTitleFontSize) state.settings.pageTitleFontSize = defaults.pageTitleFontSize;
            if (!state.settings.pageSubtitleFontSize) state.settings.pageSubtitleFontSize = defaults.pageSubtitleFontSize;
            if (!state.settings.pageTitleFont) state.settings.pageTitleFont = defaults.pageTitleFont;
            if (!state.settings.pageSubtitle) state.settings.pageSubtitle = defaults.pageSubtitle;
            if (!state.settings.pageSubtitleFont) state.settings.pageSubtitleFont = defaults.pageSubtitleFont;
            if (!state.settings.imageSearchEngine) state.settings.imageSearchEngine = defaults.imageSearchEngine;
            if (!state.settings.currentSkin) state.settings.currentSkin = defaults.currentSkin;
            
            // 确保所有颜色变量都存在
            if (!state.settings.categoryColor) state.settings.categoryColor = defaults.textColor;
            if (!state.settings.bookmarkColor) state.settings.bookmarkColor = defaults.textColor;
        }

        // 确保order字段存在
        function ensureOrderFields() {
            state.categories.sort((a, b) => (a.order || 0) - (b.order || 0));
            state.categories.forEach((category, index) => {
                if (!category.order) {
                    category.order = index + 1;
                }
            });
            
            const bookmarksByCategory = {};
            state.bookmarks.forEach(bookmark => {
                if (!bookmarksByCategory[bookmark.categoryId]) {
                    bookmarksByCategory[bookmark.categoryId] = [];
                }
                bookmarksByCategory[bookmark.categoryId].push(bookmark);
            });
            
            Object.keys(bookmarksByCategory).forEach(categoryId => {
                bookmarksByCategory[categoryId].sort((a, b) => (a.order || 0) - (b.order || 0));
                bookmarksByCategory[categoryId].forEach((bookmark, index) => {
                    bookmark.order = index + 1;
                });
            });
        }

// 2. 保存数据 (自动判断本地/云端)
        // forceCloud: 强制同步到云端（用于注册时的初始化）
        async function saveData(forceCloud = false) {
            const dataToSave = {
                categories: state.categories,
                bookmarks: state.bookmarks,
                settings: state.settings
            };
            
            // 始终保存本地（作为缓存和离线可用）
            localStorage.setItem('navPageData', JSON.stringify(dataToSave));

            // 如果登录了，同步到云端
            const user = AV.User.current();
            if (user || forceCloud) {
                try {
                    const currentUser = user || AV.User.current();
                    const query = new AV.Query('UserNavData');
                    query.equalTo('owner', currentUser);
                    let record = await query.first();

                    if (!record) {
                        const UserNavData = AV.Object.extend('UserNavData');
                        record = new UserNavData();
                        record.set('owner', currentUser);
                        // 权限设置：私有
                        const acl = new AV.ACL();
                        acl.setPublicReadAccess(false);
                        acl.setWriteAccess(currentUser, true);
                        acl.setReadAccess(currentUser, true);
                        record.setACL(acl);
                    }

                    record.set('content', dataToSave);
                    await record.save();
                    console.log('☁️ 云端同步成功');
                } catch (error) {
                    console.error('云端同步失败:', error);
                }
            }
        }

        // 渲染搜索引擎列表 (支持 SVG 和彩色) - 修复：显示彩色图标
        function renderSearchEngines() {
            elements.engineGrid.innerHTML = '';
            
            Object.entries(state.searchEngines).forEach(([key, engine]) => {
                const item = document.createElement('div');
                item.className = 'engine-grid-item';
                item.dataset.engine = key;
                
                // 【核心】注入品牌色变量，供 CSS 使用
                item.style.setProperty('--item-brand-color', engine.color);
                
                let iconHTML = '';
                // 优先使用自定义 SVG (如 Google)
                if (engine.iconHtml) {
                    iconHTML = engine.iconHtml;
                } else if (engine.icon === 'fas fa-paw') {
                    // 百度特殊处理
                    iconHTML = `<i class="fas fa-paw" style="color: ${engine.color} !important; filter: none !important;"></i>`;
                } else {
                    // 普通 FontAwesome - 使用品牌颜色
                    iconHTML = `<i class="${engine.icon}" style="color: ${engine.color} !important; filter: none !important;"></i>`;
                }
                
                item.innerHTML = `
                    <div class="engine-grid-icon">
                        ${iconHTML}
                    </div>
                    <div class="engine-grid-name">${engine.name}</div>
                `;
                
                item.addEventListener('click', () => {
                    if (state.editMode) return;
                    state.settings.searchEngine = key;
                    saveData();
                    updateSearchEngineDisplay();
                    elements.engineGrid.classList.remove('show');
                });
                
                elements.engineGrid.appendChild(item);
            });
        }

        // 渲染皮肤网格
        function renderSkinGrid() {
            elements.skinGrid.innerHTML = '';
            
            // 1. 渲染预设皮肤
            skinPresets.forEach(skin => {
                const skinItem = document.createElement('div');
                skinItem.className = 'skin-item';
                skinItem.dataset.skin = skin.id;
                
                if (state.settings.currentSkin === skin.id) {
                    skinItem.classList.add('selected');
                    state.selectedSkin = skin;
                }
                
                skinItem.innerHTML = `
                    <div class="skin-preview" style="background: url('${skin.bgValue}') center/cover; color: ${skin.textColor};">
                        <div style="position: relative; z-index: 1; font-size: 18px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${skin.name}</div>
                    </div>
                    <div class="skin-name">
                        ${skin.name}
                        <div class="skin-description">${skin.description}</div>
                    </div>
                `;
                
                const decorLayer = document.createElement('div');
                decorLayer.className = `decorative-layer ${skin.decorClass}`;
                decorLayer.style.position = 'absolute';
                decorLayer.style.top = '0';
                decorLayer.style.left = '0';
                decorLayer.style.width = '100%';
                decorLayer.style.height = '100%';
                decorLayer.style.pointerEvents = 'none';
                decorLayer.style.opacity = '0.4';
                
                skinItem.querySelector('.skin-preview').appendChild(decorLayer);
                
                skinItem.addEventListener('click', () => {
                    if (state.isUploadingBackground) return;
                    document.querySelectorAll('.skin-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    skinItem.classList.add('selected');
                    state.selectedSkin = skin;
                });
                
                elements.skinGrid.appendChild(skinItem);
            });
        }

        // 渲染图标选择器
        function renderIconSelector() {
            elements.iconSelector.innerHTML = '';
            
            const iconsByCategory = {};
            state.defaultIcons.forEach(icon => {
                if (!iconsByCategory[icon.category]) {
                    iconsByCategory[icon.category] = [];
                }
                iconsByCategory[icon.category].push(icon);
            });
            
            Object.keys(iconsByCategory).forEach(category => {
                const categoryTitle = document.createElement('div');
                categoryTitle.style.gridColumn = '1 / -1';
                categoryTitle.style.fontSize = '12px';
                categoryTitle.style.color = '#666';
                categoryTitle.style.marginTop = '10px';
                categoryTitle.style.marginBottom = '5px';
                categoryTitle.textContent = category;
                elements.iconSelector.appendChild(categoryTitle);
                
                iconsByCategory[category].forEach(icon => {
                    const iconOption = document.createElement('div');
                    iconOption.className = 'icon-option';
                    iconOption.innerHTML = `<i class="${icon.class}"></i>`;
                    iconOption.dataset.icon = icon.class;
                    iconOption.title = category;
                    
                    iconOption.addEventListener('click', () => {
                        document.querySelectorAll('.icon-option').forEach(option => {
                            option.classList.remove('selected');
                        });
                        iconOption.classList.add('selected');
                    });
                    
                    elements.iconSelector.appendChild(iconOption);
                });
            });
        }

        // 设置颜色选择器
function setupColorPickers() {
    // --- 新增安全检查 ---
    if (!state.settings.textColor) {
        // 如果数据还没准备好，先用默认值，防止报错
        state.settings = {...initialData.settings};
    }
    // ------------------

    // 文字颜色
    elements.textColorPicker.value = state.settings.textColor || '#ffffff'; // 加个保底
    elements.textColorValue.textContent = (state.settings.textColor || '#ffffff').toUpperCase();
            
            elements.textColorPicker.addEventListener('input', (e) => {
                elements.textColorValue.textContent = e.target.value.toUpperCase();
            });
            
            // 边框颜色
            elements.borderColorPicker.value = state.settings.borderColor;
            elements.borderColorValue.textContent = state.settings.borderColor.toUpperCase();
            
            elements.borderColorPicker.addEventListener('input', (e) => {
                elements.borderColorValue.textContent = e.target.value.toUpperCase();
            });
            
            // 按钮背景色
            elements.buttonBgColorPicker.value = state.settings.buttonBgColor;
            elements.buttonBgColorValue.textContent = state.settings.buttonBgColor.toUpperCase();
            
            elements.buttonBgColorPicker.addEventListener('input', (e) => {
                elements.buttonBgColorValue.textContent = e.target.value.toUpperCase();
            });
            
            // 主色调
            elements.primaryColorPicker.value = state.settings.primaryColor;
            elements.primaryColorValue.textContent = state.settings.primaryColor.toUpperCase();
            
            elements.primaryColorPicker.addEventListener('input', (e) => {
                elements.primaryColorValue.textContent = e.target.value.toUpperCase();
            });
            
            // 副色调
            elements.secondaryColorPicker.value = state.settings.secondaryColor;
            elements.secondaryColorValue.textContent = state.settings.secondaryColor.toUpperCase();
            
            elements.secondaryColorPicker.addEventListener('input', (e) => {
                elements.secondaryColorValue.textContent = e.target.value.toUpperCase();
            });
        }

        // 设置字体选择器
        function setupFontSelectors() {
            elements.fontSelector.innerHTML = '';
            
            elements.titleFontTypeBtn.addEventListener('click', () => {
                state.fontEditMode = 'title';
                elements.titleFontTypeBtn.classList.add('active');
                elements.subtitleFontTypeBtn.classList.remove('active');
                updateFontOptionsDisplay();
            });
            
            elements.subtitleFontTypeBtn.addEventListener('click', () => {
                state.fontEditMode = 'subtitle';
                elements.subtitleFontTypeBtn.classList.add('active');
                elements.titleFontTypeBtn.classList.remove('active');
                updateFontOptionsDisplay();
            });
            
            state.fontLibrary.forEach(font => {
                const fontOption = document.createElement('div');
                fontOption.className = 'font-option';
                fontOption.dataset.font = font.value;
                fontOption.textContent = font.name;
                fontOption.style.fontFamily = font.value;
                
                fontOption.addEventListener('click', () => {
                    if (state.fontEditMode === 'title') {
                        state.settings.pageTitleFont = font.value;
                    } else {
                        state.settings.pageSubtitleFont = font.value;
                    }
                    updateFontOptionsDisplay();
                });
                
                elements.fontSelector.appendChild(fontOption);
            });
            
            elements.titleFontSize.value = parseInt(state.settings.pageTitleFontSize) || 48;
            elements.titleFontSizeValue.textContent = elements.titleFontSize.value + 'px';
            
            elements.subtitleFontSize.value = parseInt(state.settings.pageSubtitleFontSize) || 24;
            elements.subtitleFontSizeValue.textContent = elements.subtitleFontSize.value + 'px';
            
            elements.titleFontSize.addEventListener('input', (e) => {
                elements.titleFontSizeValue.textContent = e.target.value + 'px';
            });
            
            elements.subtitleFontSize.addEventListener('input', (e) => {
                elements.subtitleFontSizeValue.textContent = e.target.value + 'px';
            });
            
            updateFontOptionsDisplay();
        }

        // 更新字体选项显示
        function updateFontOptionsDisplay() {
            const currentFont = state.fontEditMode === 'title' 
                ? state.settings.pageTitleFont 
                : state.settings.pageSubtitleFont;
            
            elements.fontSelector.querySelectorAll('.font-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.font === currentFont) {
                    option.classList.add('selected');
                }
                
                option.style.fontFamily = option.dataset.font;
            });
        }

        // 废弃函数占位 (防止报错)
        function renderImageSearchEngines() {
            // 已停用
        }

        // 废弃函数占位 (防止报错)
        function setupImageDragDrop() {
            // 已停用
        }

        // 处理图片文件
        function handleImageFile(file) {
            state.imageSearch.imageFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // 修复：elements.imagePreview 未定义
                const imagePreview = document.getElementById('imagePreview');
                if (imagePreview) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                state.imageSearch.uploadedImage = e.target.result;
                updateImageSearchButtonState();
            };
            reader.readAsDataURL(file);
        }

        // 更新图片搜索按钮状态
        function updateImageSearchButtonState() {
            // 修复：这些元素在代码中不存在
            // const hasImage = state.imageSearch.uploadedImage || state.imageSearch.imageUrl.trim() !== '';
            // const hasEngine = state.imageSearch.selectedEngine;
            // elements.startImageSearchBtn 不存在
        }

        // 设置导入选项
        function setupImportOptions() {
            elements.importOptionReplace.addEventListener('click', () => {
                elements.importTypeReplace.checked = true;
                updateImportOptionSelection();
                state.importType = 'replace';
            });
            
            elements.importOptionAdd.addEventListener('click', () => {
                elements.importTypeAdd.checked = true;
                updateImportOptionSelection();
                state.importType = 'add';
            });
            
            elements.importTypeReplace.addEventListener('change', () => {
                updateImportOptionSelection();
                state.importType = 'replace';
            });
            
            elements.importTypeAdd.addEventListener('change', () => {
                updateImportOptionSelection();
                state.importType = 'add';
            });
            
            updateImportOptionSelection();
        }

        // 更新导入选项选择状态
        function updateImportOptionSelection() {
            if (elements.importTypeReplace.checked) {
                elements.importOptionReplace.classList.add('selected');
                elements.importOptionAdd.classList.remove('selected');
            } else {
                elements.importOptionAdd.classList.add('selected');
                elements.importOptionReplace.classList.remove('selected');
            }
        }

        // 设置随机搜索框提示语
        function setRandomSearchPlaceholder() {
            if (searchPlaceholders && searchPlaceholders.length > 0) {
                const randomIndex = Math.floor(Math.random() * searchPlaceholders.length);
                elements.searchInput.placeholder = searchPlaceholders[randomIndex];
            }
        }

        // 预加载favicon
        function preloadFavicons() {
            state.bookmarks.forEach(bookmark => {
                if (!state.faviconCache[bookmark.url]) {
                    getFavicon(bookmark.url);
                }
            });
        }

        // 获取网站favicon
        function getFavicon(url) {
            if (state.faviconCache[url]) {
                return state.faviconCache[url];
            }
            
            try {
                const domain = new URL(url).hostname;
                // 修改为国内源，防止后台预加载时卡顿
                const faviconUrl = `https://api.iowen.cn/favicon/${domain}.png`;
                state.faviconCache[url] = faviconUrl;
                return faviconUrl;
            } catch (error) {
                state.faviconCache[url] = null;
                return null;
            }
        }

        function getDefaultIconHTML(name = '') {
            const trimmed = (name || '').trim();
            const initial = trimmed ? trimmed[0].toUpperCase() : '网';
            return `<div class="bookmark-icon-img default-favicon">${initial}</div>`;
        }

        function createDefaultIconElement(name = '') {
            const div = document.createElement('div');
            div.className = 'bookmark-icon-img default-favicon';
            const trimmed = (name || '').trim();
            div.textContent = trimmed ? trimmed[0].toUpperCase() : '网';
            return div;
        }

        // 渲染分类
        function renderCategories() {
            elements.categoriesContainer.innerHTML = '';
            
            const sortedCategories = [...state.categories].sort((a, b) => a.order - b.order);
            
            sortedCategories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.dataset.id = category.id;
                categoryItem.dataset.order = category.order;
                
                if (state.editMode) {
                    categoryItem.classList.add('edit-mode');
                    categoryItem.draggable = true;
                    
                    setupCategoryDragEvents(categoryItem, category.id);
                }
                
                const editButtons = document.createElement('div');
                editButtons.className = 'category-edit-buttons';
                editButtons.innerHTML = `
                    <button class="edit-btn-small delete-category-btn" data-id="${category.id}" title="删除分类">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="edit-btn-small rename-category-btn" data-id="${category.id}" title="重命名分类">
                        <i class="fas fa-edit"></i>
                    </button>
                `;
                
                const button = document.createElement('button');
                button.className = 'category-btn';
                if (category.id === state.currentCategory) {
                    button.classList.add('active');
                }
                button.innerHTML = `<span>${category.name}</span>`;
                button.dataset.id = category.id;
                button.style.whiteSpace = 'nowrap';
                
                button.addEventListener('click', () => {
                    setActiveCategory(category.id);
                });
                
                categoryItem.appendChild(editButtons);
                categoryItem.appendChild(button);
                elements.categoriesContainer.appendChild(categoryItem);
            });
            
            if (state.editMode) {
                const addButton = document.createElement('button');
                addButton.className = 'add-category-btn';
                addButton.innerHTML = '<i class="fas fa-plus"></i> 添加分类';
                addButton.addEventListener('click', openAddCategoryModal);
                elements.categoriesContainer.appendChild(addButton);
            }
            
            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const categoryId = parseInt(btn.dataset.id);
                    deleteCategory(categoryId);
                });
            });
            
            document.querySelectorAll('.rename-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const categoryId = parseInt(btn.dataset.id);
                    openEditCategoryModal(categoryId);
                });
            });
        }

        // 设置分类拖拽事件
        function setupCategoryDragEvents(categoryItem, categoryId) {
            categoryItem.addEventListener('dragstart', (e) => {
                state.draggingCategoryId = categoryId;
                categoryItem.classList.add('dragging');
                e.dataTransfer.setData('text/plain', categoryId);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setDragImage(categoryItem, 20, 20);
            });
            
            categoryItem.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (state.draggingCategoryId !== categoryId) {
                    categoryItem.classList.add('drag-over');
                }
            });
            
            categoryItem.addEventListener('dragenter', (e) => {
                if (state.draggingCategoryId !== categoryId) {
                    categoryItem.classList.add('drag-over');
                }
            });
            
            categoryItem.addEventListener('dragleave', (e) => {
                categoryItem.classList.remove('drag-over');
            });
            
            categoryItem.addEventListener('drop', (e) => {
                e.preventDefault();
                categoryItem.classList.remove('drag-over');
                
                if (state.draggingCategoryId && state.draggingCategoryId !== categoryId) {
                    const draggingCategory = state.categories.find(c => c.id === state.draggingCategoryId);
                    const targetCategory = state.categories.find(c => c.id === categoryId);
                    
                    if (draggingCategory && targetCategory) {
                        const categories = [...state.categories];
                        const draggingIndex = categories.findIndex(c => c.id === state.draggingCategoryId);
                        const targetIndex = categories.findIndex(c => c.id === categoryId);
                        
                        const [draggedItem] = categories.splice(draggingIndex, 1);
                        categories.splice(targetIndex, 0, draggedItem);
                        
                        categories.forEach((cat, index) => {
                            cat.order = index + 1;
                        });
                        
                        state.categories = categories;
                        
                        saveData();
                        renderCategories();
                        
                        if (state.currentCategory === state.draggingCategoryId) {
                            state.currentCategory = categoryId;
                        }
                    }
                }
            });
            
            categoryItem.addEventListener('dragend', (e) => {
                categoryItem.classList.remove('dragging');
                categoryItem.classList.remove('drag-over');
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                state.draggingCategoryId = null;
            });
        }

        // 渲染书签 - 修复：字体粗细调整
        function renderBookmarks() {
            elements.bookmarksContainer.innerHTML = '';
            
            const sortedCategories = [...state.categories].sort((a, b) => a.order - b.order);
            
            sortedCategories.forEach(category => {
                const section = document.createElement('div');
                section.className = 'bookmarks-section';
                section.id = `category-${category.id}`;
                
                if (category.id === state.currentCategory) {
                    section.classList.add('active');
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
                
                const grid = document.createElement('div');
                grid.className = 'bookmarks-grid';
                
                const categoryBookmarks = state.bookmarks
                    .filter(bookmark => bookmark.categoryId === category.id)
                    .sort((a, b) => a.order - b.order);
                
                categoryBookmarks.forEach(bookmark => {
                    const bookmarkElement = createBookmarkElement(bookmark, category.id);
                    grid.appendChild(bookmarkElement);
                });
                
                const rows = state.settings.rowsPerCategory || 4;
                const totalSlots = rows * 6;
                const emptySlots = totalSlots - categoryBookmarks.length;

                for (let i = 0; i < emptySlots; i++) {
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'bookmark-item empty-slot';
                    emptySlot.innerHTML = `<div class="bookmark-icon" style="background:transparent;"><i class="fas fa-plus" style="opacity:0.3"></i></div><div class="bookmark-name">空位</div>`;
                    
                    if (state.editMode) {
                        emptySlot.style.opacity = '0.5';
                        emptySlot.style.cursor = 'pointer';
                        emptySlot.style.visibility = 'visible';
                        emptySlot.addEventListener('click', () => {
                            openAddBookmarkModal(category.id);
                        });
                    }
                    grid.appendChild(emptySlot);
                }
                
                if (state.editMode) {
                    const addRowBtn = document.createElement('button');
                    addRowBtn.className = 'add-row-btn';
                    addRowBtn.innerHTML = '<i class="fas fa-plus-circle"></i> 增加一行';
                    addRowBtn.addEventListener('click', () => {
                        changeRowsPerCategory('add');
                    });
                    grid.appendChild(addRowBtn);
                    
                    // 【修复1：删除行功能 - 只显示删除按钮当行数大于1时】
                    const currentRows = state.settings.rowsPerCategory || 4;
                    if (currentRows > 1) {
                        const removeRowBtn = document.createElement('button');
                        removeRowBtn.className = 'remove-row-btn';
                        removeRowBtn.innerHTML = '<i class="fas fa-minus-circle"></i> 减少一行';
                        removeRowBtn.addEventListener('click', () => {
                            changeRowsPerCategory('remove');
                        });
                        grid.appendChild(removeRowBtn);
                    }
                }
                
                section.appendChild(grid);
                elements.bookmarksContainer.appendChild(section);
            });
        }

        function createBookmarkElement(bookmark) {
            try {
                // 1. 创建外层容器
                const item = document.createElement('a');
                item.className = 'bookmark-item';
                item.href = bookmark.url;
                item.target = '_blank';
                item.style.cssText = 'min-width:190px; display:flex; align-items:center; padding:8px;';

                item.dataset.id = bookmark.id;
                item.dataset.category = bookmark.categoryId || 0;
                item.dataset.order = bookmark.order || 0;

                // ===========================================
                // 2. 【核心】定义好看的备用图标库
                // ===========================================
                const niceIcons = [
                    { color: '#ff9800', icon: 'fas fa-link' },       
                    { color: '#2196f3', icon: 'fas fa-globe-americas' }, 
                    { color: '#4caf50', icon: 'fas fa-leaf' },       
                    { color: '#9c27b0', icon: 'fas fa-plane' },      
                    { color: '#e91e63', icon: 'fas fa-ticket-alt' }, 
                    { color: '#00bcd4', icon: 'fas fa-ship' },       
                    { color: '#ff5722', icon: 'fas fa-fire' },       
                    { color: '#673ab7', icon: 'fas fa-passport' },   
                    { color: '#3f51b5', icon: 'fab fa-internet-explorer' }
                ];

                const iconIndex = (bookmark.id || 0) % niceIcons.length;
                const myNiceIcon = niceIcons[iconIndex];

                // ===========================================
                // 3. 图标容器：默认直接显示"好看的彩色图标"
                // ===========================================
                const iconDiv = document.createElement('div');
                iconDiv.className = 'bookmark-icon';
                iconDiv.style.cssText = `background:${myNiceIcon.color}; width:32px; height:32px; flex-shrink:0; border-radius:50%; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; transition: all 0.3s;`;

                const placeholderIcon = document.createElement('i');
                placeholderIcon.className = myNiceIcon.icon;
                placeholderIcon.style.cssText = 'color:#fff; font-size:14px; position:absolute; z-index:1;';
                iconDiv.appendChild(placeholderIcon);

                // ===========================================
                // 4. Google源加载逻辑
                // ===========================================
                
                if (bookmark.customIcon && !bookmark.customIcon.includes('/') && !bookmark.customIcon.includes('.')) {
                     iconDiv.style.background = 'transparent';
                     iconDiv.innerHTML = `<i class="${bookmark.customIcon}" style="font-size:18px; color:#fff;"></i>`;
                } 
                else {
                    let targetSrc = '';
                    
                    if (bookmark.customIcon) {
                        targetSrc = bookmark.customIcon;
                    } else {
                        let domain = '';
                        try { domain = new URL(bookmark.url).hostname; } catch(e){}
                        targetSrc = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                    }

                    const img = new Image();
                    img.src = targetSrc;

                    img.onload = () => {
                        if (img.naturalWidth < 32 && !bookmark.customIcon) {
                            return;
                        }

                        iconDiv.style.background = 'transparent'; 
                        iconDiv.style.borderRadius = '0';
                        iconDiv.innerHTML = '';

                        const realImg = document.createElement('img');
                        realImg.src = targetSrc;
                        realImg.style.cssText = 'width:100%; height:100%; object-fit:contain; border-radius:4px; animation: fadeIn 0.5s;';
                        iconDiv.appendChild(realImg);
                    };

                    img.onerror = () => {
                        // 保持默认彩色图标
                    };
                }

                // 5. 网站名称 - 修复：使用稍细的字体
                const nameDiv = document.createElement('div');
                nameDiv.textContent = bookmark.name;
                nameDiv.style.cssText = 'flex:1; margin-left:12px; font-weight:500; font-size:20px; color:var(--text-color); white-space:nowrap; overflow:hidden; text-overflow:clip;';

                // 6. 组装
                item.append(iconDiv, nameDiv);

                // 编辑模式
                if (typeof state !== 'undefined' && state.editMode) {
                    item.style.position = 'relative'; 
                    item.style.overflow = 'visible';
                    
                    item.draggable = true;
                    item.onclick = (e) => { 
                        e.preventDefault(); 
                        if (e.target.closest('.edit-btn-small')) {
                            e.stopPropagation();
                        }
                        openEditBookmarkModal(bookmark.id); 
                    };
                    
                    item.ondragstart = (e) => { 
                        e.dataTransfer.setData('text/plain', JSON.stringify({type:'bookmark', id:bookmark.id})); 
                        if(state) state.draggingBookmarkId = bookmark.id; 
                    };

                    const btn = document.createElement('div'); 
                    btn.className = 'edit-btn-small'; 
                    btn.innerHTML = '<i class="fas fa-edit"></i>'; 
                    btn.style.cssText = 'position: absolute; top: -8px; right: -8px; z-index: 10;'; 
                    item.appendChild(btn);
                }

                return item;
            } catch (e) { console.error(e); return document.createElement('div'); }
        }

        // 设置书签拖拽事件
        function setupBookmarkDragEvents(item, bookmarkId) {
            item.addEventListener('dragstart', (e) => {
                state.draggingBookmarkId = bookmarkId;
                state.dragTargetIndex = -1;
                item.classList.add('dragging');
                e.dataTransfer.setData('text/plain', bookmarkId);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setDragImage(item, 20, 20);
                
                // 添加占位符
                const placeholder = document.createElement('div');
                placeholder.className = 'bookmark-drag-placeholder';
                placeholder.style.width = item.offsetWidth + 'px';
                placeholder.style.height = item.offsetHeight + 'px';
                placeholder.dataset.placeholder = 'true';
                item.parentNode.insertBefore(placeholder, item);
            });
            
            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (state.draggingBookmarkId !== bookmarkId) {
                    item.classList.add('drag-over');
                    
                    // 计算目标位置
                    const rect = item.getBoundingClientRect();
                    const verticalMiddle = rect.top + rect.height / 2;
                    const horizontalMiddle = rect.left + rect.width / 2;
                    
                    // 根据拖拽位置决定插入位置
                    if (e.clientY < verticalMiddle) {
                        // 插入到当前元素之前
                        state.dragTargetIndex = Array.from(item.parentNode.children).indexOf(item);
                    } else {
                        // 插入到当前元素之后
                        state.dragTargetIndex = Array.from(item.parentNode.children).indexOf(item) + 1;
                    }
                }
            });
            
            item.addEventListener('dragenter', (e) => {
                if (state.draggingBookmarkId !== bookmarkId) {
                    item.classList.add('drag-over');
                }
            });
            
            item.addEventListener('dragleave', (e) => {
                // 只有当鼠标离开元素且不进入子元素时才移除高亮
                if (!item.contains(e.relatedTarget)) {
                    item.classList.remove('drag-over');
                }
            });
            
            item.addEventListener('drop', (e) => {
                e.preventDefault();
                item.classList.remove('drag-over');
                
                if (state.draggingBookmarkId && state.draggingBookmarkId !== bookmarkId) {
                    const draggingBookmark = state.bookmarks.find(b => b.id === state.draggingBookmarkId);
                    const targetBookmark = state.bookmarks.find(b => b.id === bookmarkId);
                    
                    if (draggingBookmark && targetBookmark && draggingBookmark.categoryId === targetBookmark.categoryId) {
                        const categoryBookmarks = state.bookmarks
                            .filter(b => b.categoryId === draggingBookmark.categoryId)
                            .sort((a, b) => a.order - b.order);
                        
                        const draggingIndex = categoryBookmarks.findIndex(b => b.id === state.draggingBookmarkId);
                        const targetIndex = categoryBookmarks.findIndex(b => b.id === bookmarkId);
                        
                        // 调整位置
                        const [draggedItem] = categoryBookmarks.splice(draggingIndex, 1);
                        
                        // 根据拖拽时的位置决定插入点
                        let insertIndex;
                        if (state.dragTargetIndex !== -1) {
                            // 使用计算出的目标位置
                            insertIndex = state.dragTargetIndex > draggingIndex ? state.dragTargetIndex - 1 : state.dragTargetIndex;
                        } else {
                            // 回退到基于鼠标位置的计算
                            const rect = item.getBoundingClientRect();
                            const verticalMiddle = rect.top + rect.height / 2;
                            insertIndex = e.clientY < verticalMiddle ? targetIndex : targetIndex + 1;
                        }
                        
                        // 确保索引有效
                        insertIndex = Math.max(0, Math.min(insertIndex, categoryBookmarks.length));
                        categoryBookmarks.splice(insertIndex, 0, draggedItem);
                        
                        // 重新排序
                        categoryBookmarks.forEach((bookmark, index) => {
                            bookmark.order = index + 1;
                        });
                        
                        saveData();
                        renderBookmarks();
                    }
                }
            });
            
            item.addEventListener('dragend', (e) => {
                item.classList.remove('dragging');
                item.classList.remove('drag-over');
                document.querySelectorAll('.bookmark-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                
                // 移除所有占位符
                document.querySelectorAll('[data-placeholder="true"]').forEach(placeholder => {
                    placeholder.remove();
                });
                
                state.draggingBookmarkId = null;
                state.dragTargetIndex = -1;
            });
        }

        // 设置活动分类
        function setActiveCategory(categoryId, initialLoad = false) {
            state.currentCategory = categoryId;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                if (parseInt(btn.dataset.id) === categoryId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.bookmarks-section').forEach(section => {
                if (section.id === `category-${categoryId}`) {
                    section.classList.add('active');
                    section.style.display = 'block';
                } else {
                    section.classList.remove('active');
                    section.style.display = 'none';
                }
            });
        }
// 更新搜索框左侧图标 (修复版：完美支持悬停变色)
        function updateSearchEngineDisplay() {
            const engine = state.searchEngines[state.settings.searchEngine];
            if (engine) {
                // 1. 设置品牌颜色变量到父容器 (CSS hover 时会读取这个变量)
                elements.currentEngine.style.setProperty('--item-brand-color', engine.color);
                
                let iconContent = '';
                
                // 2. 生成图标 HTML (注意：这里不再写死 style="color:..."，交给CSS控制)
                if (engine.iconHtml) {
                    // Google 等 SVG 图标
                    iconContent = engine.iconHtml;
                } else if (engine.icon === 'fas fa-paw') {
                    // 百度 (FontAwesome)
                    iconContent = `<i class="fas fa-paw"></i>`;
                } else {
                    // 其他 (FontAwesome)
                    const iconClass = engine.icon || 'fas fa-search';
                    iconContent = `<i class="${iconClass}"></i>`;
                }

                elements.currentEngine.innerHTML = `
                    ${iconContent}
                    <span class="engine-name" style="display: none;">${engine.name}</span>
                `;
                elements.currentEngine.title = engine.name;
            }
        }

        // 更新搜索功能状态
        function updateSearchFunctionState() {
            if (state.editMode) {
                elements.searchInput.classList.add('disabled');
                elements.searchInput.disabled = true;
                elements.searchBtn.classList.add('disabled');
                elements.imageSearchBtn.classList.add('disabled');
                elements.currentEngine.style.opacity = '0.5';
                elements.currentEngine.style.cursor = 'not-allowed';
                elements.currentEngine.style.pointerEvents = 'none';
            } else {
                elements.searchInput.classList.remove('disabled');
                elements.searchInput.disabled = false;
                elements.searchBtn.classList.remove('disabled');
                elements.imageSearchBtn.classList.remove('disabled');
                elements.currentEngine.style.opacity = '1';
                elements.currentEngine.style.cursor = 'pointer';
                elements.currentEngine.style.pointerEvents = 'auto';
            }
        }

        // 打开识图搜图窗口 (极简修复版)
        function openImageSearchModal() {
            const modal = document.getElementById('imageSearchModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // 执行图片搜索
        function performImageSearch() {
            const engine = imageSearchEnginesData[state.imageSearch.selectedEngine];
            if (!engine) return;
            
            let searchUrl = engine.url;
            
            if (engine.method === 'url') {
                // 对于URL传参的搜索引擎，检查是否有图片URL
                if (state.imageSearch.imageUrl.trim() !== '') {
                    searchUrl += encodeURIComponent(state.imageSearch.imageUrl);
                    window.open(searchUrl, '_blank');
                } else if (state.imageSearch.uploadedImage) {
                    // 对于上传的图片，将其转换为Data URL并上传
                    const dataUrl = state.imageSearch.uploadedImage;
                    
                    if (state.imageSearch.selectedEngine === 'google') {
                        searchUrl += encodeURIComponent(dataUrl);
                        window.open(searchUrl, '_blank');
                    } else if (state.imageSearch.selectedEngine === 'bing') {
                        searchUrl += encodeURIComponent(dataUrl);
                        window.open(searchUrl, '_blank');
                    } else if (state.imageSearch.selectedEngine === 'yandex') {
                        searchUrl += encodeURIComponent(dataUrl);
                        window.open(searchUrl, '_blank');
                    } else {
                        alert('该搜索引擎不支持直接上传图片，请使用百度识图或提供图片URL');
                        return;
                    }
                } else {
                    alert('请提供图片URL或上传图片');
                    return;
                }
            } else if (engine.method === 'redirect') {
                // 对于百度识图，直接跳转到上传页面
                window.open(searchUrl, '_blank');
            }
            
            closeModal(elements.imageSearchModal);
        }

        // 打开编辑书签模态框
        function openEditBookmarkModal(bookmarkId) {
            const bookmark = state.bookmarks.find(b => b.id === bookmarkId);
            if (!bookmark) return;
            
            state.editingBookmarkId = bookmarkId;
            
            const editBookmarkName = document.getElementById('editBookmarkName');
            const editBookmarkUrl = document.getElementById('editBookmarkUrl');
            
            editBookmarkName.value = bookmark.name;
            editBookmarkUrl.value = bookmark.url;
            
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
                if (bookmark.customIcon && option.dataset.icon === bookmark.customIcon) {
                    option.classList.add('selected');
                }
            });
            
            elements.editBookmarkModal.style.display = 'flex';
        }

        // 打开添加书签模态框
        function openAddBookmarkModal(categoryId) {
            state.editingBookmarkId = null;
            
            const editBookmarkName = document.getElementById('editBookmarkName');
            const editBookmarkUrl = document.getElementById('editBookmarkUrl');
            
            editBookmarkName.value = '';
            editBookmarkUrl.value = '';
            
            document.querySelectorAll('.icon-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            state.currentCategory = categoryId;
            elements.editBookmarkModal.style.display = 'flex';
        }

        // 打开编辑分类模态框
        function openEditCategoryModal(categoryId) {
            const category = state.categories.find(c => c.id === categoryId);
            if (!category) return;
            
            state.editingCategoryId = categoryId;
            document.getElementById('editCategoryName').value = category.name;
            elements.editCategoryModal.style.display = 'flex';
        }

        // 打开添加分类模态框
        function openAddCategoryModal() {
            state.editingCategoryId = null;
            document.getElementById('addCategoryName').value = '';
            elements.addCategoryModal.style.display = 'flex';
        }

        // 删除分类
        function deleteCategory(categoryId) {
            showConfirmDialog('删除分类', '确定要删除这个分类吗？此操作会删除该分类下的所有网站！', () => {
                state.categories = state.categories.filter(c => c.id !== categoryId);
                state.bookmarks = state.bookmarks.filter(b => b.categoryId !== categoryId);
                
                if (state.currentCategory === categoryId && state.categories.length > 0) {
                    state.currentCategory = state.categories[0].id;
                } else if (state.categories.length === 0) {
                    state.currentCategory = null;
                }
                
                saveData();
                renderCategories();
                renderBookmarks();
            });
        }

        // 显示确认对话框
        function showConfirmDialog(title, message, onConfirm) {
            elements.confirmDialogTitle.textContent = title;
            elements.confirmDialogMessage.textContent = message;
            elements.confirmDialog.style.display = 'flex';
            
            elements.confirmDialogConfirmBtn.onclick = () => {
                closeModal(elements.confirmDialog);
                if (onConfirm) onConfirm();
            };
            
            elements.confirmDialogCancelBtn.onclick = () => {
                closeModal(elements.confirmDialog);
            };
        }

        // 【修复1：改变每行书签数量 - 修复删除行逻辑】
        function changeRowsPerCategory(action) {
            const currentRows = state.settings.rowsPerCategory || 4;
            
            if (action === 'add' && currentRows < 8) {
                // 增加行：总是可以增加，不管上一行是不是空行
                state.settings.rowsPerCategory = currentRows + 1;
            } else if (action === 'remove' && currentRows > 1) {
                // 删除行：确保至少保留1行
                // 计算当前分类的实际书签数量
                const currentCategoryBookmarks = state.bookmarks.filter(b => b.categoryId === state.currentCategory);
                const actualBookmarkCount = currentCategoryBookmarks.length;
                const slotsPerRow = 6;
                const neededRows = Math.ceil(actualBookmarkCount / slotsPerRow);
                
                // 不能删除到少于需要的行数
                if (currentRows - 1 >= neededRows) {
                    state.settings.rowsPerCategory = currentRows - 1;
                } else {
                    alert(`无法删除这一行。当前分类有${actualBookmarkCount}个书签，至少需要${neededRows}行来显示。`);
                    return;
                }
            }
            
            saveData();
            renderBookmarks();
        }

        // 导出数据
        function exportData() {
            let exportText = '';
            
            const sortedCategories = [...state.categories].sort((a, b) => a.order - b.order);
            
            sortedCategories.forEach(category => {
                exportText += `【${category.name}】\n`;
                
                const categoryBookmarks = state.bookmarks
                    .filter(bookmark => bookmark.categoryId === category.id)
                    .sort((a, b) => a.order - b.order);
                
                categoryBookmarks.forEach(bookmark => {
                    exportText += `${bookmark.name} | ${bookmark.url}\n`;
                });
                
                exportText += '\n';
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `导航页数据备份_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 显示错误信息
        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }

        // 关闭模态框 - 修复：编辑网站和编辑分类模态框不允许点击外部关闭
        function closeModal(modal) {
            modal.style.display = 'none';
        }

        // 执行搜索
        function performSearch() {
            if (state.editMode) return;
            
            const query = elements.searchInput.value.trim();
            if (!query) return;
            
            if (query.includes('.') && (query.startsWith('http://') || query.startsWith('https://') || query.includes('.'))) {
                let url = query;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank');
            } else {
                const engine = state.searchEngines[state.settings.searchEngine];
                if (engine) {
                    window.open(engine.url + encodeURIComponent(query), '_blank');
                }
            }
            
            elements.searchInput.value = '';
        }

        // 切换编辑模式
        function toggleEditMode() {
            state.editMode = !state.editMode;
            document.body.classList.toggle('edit-mode', state.editMode);
            
            if (state.editMode) {
                elements.settingsBtn.innerHTML = '<i class="fas fa-check"></i>';
                elements.settingsBtn.classList.add('confirm-mode');
                elements.settingsBtnMode = 'confirm';
                elements.settingsMenu.classList.remove('show');
                elements.dragHint.style.display = 'block';
            } else {
                exitEditMode();
            }
            
            updateSearchFunctionState();
            renderCategories();
            renderBookmarks();
        }

        // 退出编辑模式
        function exitEditMode() {
            state.editMode = false;
            document.body.classList.remove('edit-mode');
            elements.settingsBtn.innerHTML = '<i class="fas fa-cog"></i>';
            elements.settingsBtn.classList.remove('confirm-mode');
            elements.settingsBtnMode = 'settings';
            elements.dragHint.style.display = 'none';
            updateSearchFunctionState();
            renderCategories();
            renderBookmarks();
        }

        // 打开配色与背景模态框
        function openColorBgModal() {
            elements.editTitleText.value = state.settings.pageTitle || '';
            elements.editSubtitleText.value = state.settings.pageSubtitle || '';
            
            if (state.settings.pageTitleIcon) {
                elements.titleIconPreview.src = state.settings.pageTitleIcon;
                elements.titleIconPreview.style.display = 'block';
            } else {
                elements.titleIconPreview.style.display = 'none';
            }
            
            elements.settingsMenu.classList.remove('show');
            elements.colorBgModal.style.display = 'flex';
            
            // 更新颜色选择器的值
            elements.textColorPicker.value = state.settings.textColor;
            elements.textColorValue.textContent = state.settings.textColor.toUpperCase();
            elements.borderColorPicker.value = state.settings.borderColor;
            elements.borderColorValue.textContent = state.settings.borderColor.toUpperCase();
            elements.buttonBgColorPicker.value = state.settings.buttonBgColor;
            elements.buttonBgColorValue.textContent = state.settings.buttonBgColor.toUpperCase();
            elements.primaryColorPicker.value = state.settings.primaryColor;
            elements.primaryColorValue.textContent = state.settings.primaryColor.toUpperCase();
            elements.secondaryColorPicker.value = state.settings.secondaryColor;
            elements.secondaryColorValue.textContent = state.settings.secondaryColor.toUpperCase();
        }

        // 应用颜色
        function applyColors() {
            state.settings.textColor = elements.textColorPicker.value;
            state.settings.borderColor = elements.borderColorPicker.value;
            state.settings.buttonBgColor = elements.buttonBgColorPicker.value;
            state.settings.primaryColor = elements.primaryColorPicker.value;
            state.settings.secondaryColor = elements.secondaryColorPicker.value;
            state.settings.currentSkin = 'custom';
            
            // 统一其他文字颜色
            state.settings.categoryColor = state.settings.textColor;
            state.settings.bookmarkColor = state.settings.textColor;
            
            // 计算按钮悬停颜色
            const rgb = hexToRgb(state.settings.buttonBgColor);
            if (rgb) {
                // 稍微加深颜色作为悬停颜色
                const hoverR = Math.max(0, rgb.r - 30);
                const hoverG = Math.max(0, rgb.g - 30);
                const hoverB = Math.max(0, rgb.b - 30);
                state.settings.buttonHoverBgColor = `rgba(${hoverR}, ${hoverG}, ${hoverB}, 0.25)`;
            }
            
            saveData();
            applySettings();
            closeModal(elements.colorBgModal);
        }

        // 将十六进制颜色转换为RGB
        function hexToRgb(hex) {
            // 移除#号
            hex = hex.replace('#', '');
            
            // 解析RGB值
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            return { r, g, b };
        }

        // 应用字体
        function applyFonts() {
            const titleText = elements.editTitleText.value.trim();
            const subtitleText = elements.editSubtitleText.value.trim();
            
            // 限制副标题长度为30个字符
            if (subtitleText.length > 30) {
                alert('副标题最多只能输入30个字符');
                return;
            }
            
            state.settings.pageTitle = titleText;
            state.settings.pageSubtitle = subtitleText;
            
            if (state.titleIconPreview) {
                state.settings.pageTitleIcon = state.titleIconPreview;
            } else if (elements.titleIconPreview.src) {
                state.settings.pageTitleIcon = elements.titleIconPreview.src;
            } else {
                state.settings.pageTitleIcon = '';
            }
            
            state.settings.pageTitleFontSize = elements.titleFontSize.value + 'px';
            state.settings.pageSubtitleFontSize = elements.subtitleFontSize.value + 'px';
            
            saveData();
            applySettings();
            closeModal(elements.colorBgModal);
        }

        // 保存书签
        function saveBookmark(e) {
            e.preventDefault();
            
            const name = document.getElementById('editBookmarkName').value.trim();
            const url = document.getElementById('editBookmarkUrl').value.trim();
            
            if (!name || !url) {
                alert('请填写完整信息');
                return;
            }
            
            let finalUrl = url;
            if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                finalUrl = 'https://' + finalUrl;
            }
            
            const selectedIcon = document.querySelector('.icon-option.selected');
            const customIcon = selectedIcon ? selectedIcon.dataset.icon : null;
            
            if (state.editingBookmarkId) {
                const bookmark = state.bookmarks.find(b => b.id === state.editingBookmarkId);
                if (bookmark) {
                    bookmark.name = name;
                    bookmark.url = finalUrl;
                    bookmark.customIcon = customIcon;
                }
            } else {
                const newId = state.bookmarks.length > 0 ? Math.max(...state.bookmarks.map(b => b.id)) + 1 : 1;
                const categoryBookmarks = state.bookmarks.filter(b => b.categoryId === state.currentCategory);
                const newOrder = categoryBookmarks.length + 1;
                
                state.bookmarks.push({
                    id: newId,
                    name,
                    url: finalUrl,
                    categoryId: state.currentCategory,
                    order: newOrder,
                    customIcon
                });
            }
            
            saveData();
            renderBookmarks();
            closeModal(elements.editBookmarkModal);
        }

        // 保存分类
        function saveCategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('editCategoryName').value.trim();
            if (!name) {
                alert('请输入分类名称');
                return;
            }
            
            const category = state.categories.find(c => c.id === state.editingCategoryId);
            if (category) {
                category.name = name;
            }
            
            saveData();
            renderCategories();
            closeModal(elements.editCategoryModal);
        }

        // 【修复3：添加分类时立即显示空行】
        function addCategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('addCategoryName').value.trim();
            if (!name) {
                alert('请输入分类名称');
                return;
            }
            
            const newId = state.categories.length > 0 ? Math.max(...state.categories.map(c => c.id)) + 1 : 1;
            const newOrder = state.categories.length + 1;
            
            state.categories.push({
                id: newId,
                name,
                order: newOrder
            });
            
            // 设置当前分类为新分类
            state.currentCategory = newId;
            
            saveData();
            renderCategories();
            // 立即渲染书签，显示空行
            renderBookmarks();
            closeModal(elements.addCategoryModal);
        }

        // 确保 HTML 中的 onclick 能调用到这个关闭函数
        window.closeImageSearchModal = function() {
            const modal = document.getElementById('imageSearchModal');
            if (modal) {
                modal.style.display = 'none';
            }
        };

        initApp();
    </script>
</body>
</html>